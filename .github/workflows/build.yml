name: Build ImmortalWrt SL3000 eMMC (Auto Three-Piece)

on:
  workflow_dispatch:

# å…¨å±€æƒé™ï¼šæ»¡è¶³ä»£ç æ¨é€ã€Releaseå‘å¸ƒã€Artifactä¸Šä¼ ã€ä»“åº“æ‹‰å–
permissions:
  contents: write
  actions: read
  packages: write

jobs:
  build-sl3000-firmware:
    runs-on: ubuntu-22.04
    timeout-minutes: 360  # å»¶é•¿è¶…æ—¶æ—¶é—´ï¼Œé€‚é…MT7981Bå›ºä»¶å®Œæ•´ç¼–è¯‘
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout local repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: repo  # æ˜¾å¼æŒ‡å®šè·¯å¾„ï¼Œé¿å…ä¸openwrtç›®å½•å†²çª

      - name: Optimize disk space (Ubuntu 22.04 Runner)
        run: |
          # å¸è½½æ— ç”¨ç»„ä»¶ï¼Œé‡Šæ”¾è¶…20Gç£ç›˜ç©ºé—´
          sudo apt-get remove -y --purge azure-cli google-cloud-sdk dotnet powershell mono mysql-server php* android* snapd || true
          sudo apt-get autoremove -y --purge
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/* /usr/share/doc /usr/share/man
          # æ·»åŠ 10G swapåˆ†åŒºï¼Œè§£å†³ç¼–è¯‘OOMæ ¸å¿ƒé—®é¢˜
          sudo fallocate -l 10G /swapfile && sudo mkswap /swapfile && sudo swapon /swapfile
          free -h && df -h

      - name: Install build dependencies (é€‚é…ImmortalWrt 24.10/Linux 6.6)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential git-core libncurses5-dev \
            zlib1g-dev gawk flex gettext wget unzip python3 python3-distutils \
            file libssl-dev rsync ccache device-tree-compiler subversion libelf-dev \
            bc bison patch gcc-multilib g++-multilib swig libudev-dev libusb-1.0-0-dev

      - name: Clone your ImmortalWrt source (ç²¾å‡†å¯¹é½ ykm888/immortalwrt-sl3000)
        run: |
          # å®¹é”™åˆ é™¤æ—§ç›®å½•ï¼Œé¿å…æƒé™/æ®‹ç•™å†²çª
          sudo rm -rf openwrt || true
          # æ‹‰å–ä½ çš„ä»“åº“æº + mainåˆ†æ”¯ï¼ˆè´´åˆè¯¥ä»“åº“é»˜è®¤åˆ†æ”¯ï¼‰
          git clone --depth=1 -b main https://github.com/ykm888/immortalwrt-sl3000.git openwrt
          cd openwrt
          # åˆå§‹åŒ–å­æ¨¡å—ï¼Œé¿å…æºç ç¼ºå¤±
          git submodule update --init --recursive || true
          echo "âœ… ä»“åº“æ‹‰å–å®Œæˆï¼šykm888/immortalwrt-sl3000 (main)"

      - name: Cache downloads & ccache (cloneåæ‰§è¡Œï¼Œç¼“å­˜100%ç”Ÿæ•ˆ)
        uses: actions/cache@v4
        with:
          path: |
            openwrt/dl
            openwrt/.ccache
          key: ${{ runner.os }}-sl3000-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-sl3000-

      - name: Copy SL3000 tools & add execute permission
        run: |
          # ä»æœ¬åœ°repoå¤åˆ¶å·¥å…·åˆ°openwrtæ„å»ºç›®å½•
          cp -r repo/sl3000-tools openwrt/
          # ç»™å·¥å…·ç›®å½•ä¸‹ALL .shè„šæœ¬åŠ æ‰§è¡Œæƒé™ï¼Œå½»åº•è§£å†³æƒé™é—®é¢˜
          chmod +x openwrt/sl3000-tools/*.sh
          ls -l openwrt/sl3000-tools/
          echo "âœ… å·¥å…·å¤åˆ¶å®Œæˆï¼Œæ‰€æœ‰è„šæœ¬å·²æˆæƒæ‰§è¡Œ"

      - name: Update & install ImmortalWrt feeds (å®¹é”™+å¼ºåˆ¶å®‰è£…Luciæ ¸å¿ƒ)
        working-directory: openwrt
        run: |
          ./scripts/feeds update -a --force || true
          # å¼ºåˆ¶å®‰è£…luciæ ¸å¿ƒfeedsï¼Œè§£å†³luciä¾èµ–ç¼ºå¤±æ ¹æœ¬é—®é¢˜
          ./scripts/feeds install -a -f luci luci-base luci-i18n-base-zh-cn || true
          ./scripts/feeds clean || true
          echo "âœ… Feedsæ›´æ–°&å®‰è£…å®Œæˆï¼Œå·²å¼ºåˆ¶å®‰è£…Luciæ ¸å¿ƒåŒ…"

      - name: Generate SL3000 Three-Piece Set (è¿è¡Œç”Ÿæˆè„šæœ¬)
        working-directory: openwrt
        run: |
          # æ‰§è¡Œä¸‰ä»¶å¥—ç”Ÿæˆè„šæœ¬ï¼Œè‡ªåŠ¨ç”ŸæˆDTS/MK/CONFIG
          ./sl3000-tools/generate-three-piece.sh
          # åŒå±‚éªŒè¯ï¼šé…ç½®+æ–‡ä»¶ï¼Œç¡®ä¿ç”ŸæˆæˆåŠŸ
          if grep -q "CONFIG_PACKAGE_luci-base=y" .config; then
            echo "âœ… Luciæ ¸å¿ƒåŒ…é…ç½®å·²æˆåŠŸç”Ÿæˆ"
          else
            echo "âŒ Luciæ ¸å¿ƒåŒ…é…ç½®æœªç”Ÿæˆï¼Œæ„å»ºç»ˆæ­¢"
            cat .config && exit 1
          fi
          if [ -f "target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts" ]; then
            echo "âœ… DTSæ–‡ä»¶å·²æˆåŠŸç”Ÿæˆ"
          else
            echo "âŒ DTSæ–‡ä»¶ç”Ÿæˆå¤±è´¥ï¼Œæ„å»ºç»ˆæ­¢"
            exit 1
          fi

      - name: Normalize config & init CCACHE (æ ¸å¿ƒä¿®å¤ï¼šç›®å½•+ccache+é…ç½®é”å®š)
        working-directory: openwrt
        run: |
          # 1. æå‰åˆ›å»º.ccacheç›®å½•å¹¶èµ‹æƒï¼Œè§£å†³é…ç½®æ–‡ä»¶å†™å…¥å¤±è´¥
          mkdir -p .ccache
          chmod 777 .ccache
          # 2. é…ç½®ccacheå¹¶å¼ºåˆ¶è®¾ç½®10Gç¼“å­˜ï¼ˆè¦†ç›–é»˜è®¤5Gï¼‰
          echo 'max_size = 10G' > .ccache/ccache.conf
          echo 'compression = true' >> .ccache/ccache.conf
          echo 'cache_dir = .ccache' >> .ccache/ccache.conf
          ccache -C && ccache -z && ccache -s && ccache -F 10G
          # 3. æ ¸å¿ƒä¿®å¤ï¼šåˆ›å»ºconfigsç›®å½•ï¼Œè§£å†³mv defconfigå¤±è´¥é—®é¢˜
          mkdir -p configs
          # 4. å¼ºåˆ¶å°†è‡ªå®šä¹‰.configè®¾ä¸ºé»˜è®¤é…ç½®ï¼Œé¿å…è¢«OpenWrtè¦†ç›–
          cp .config defconfig
          mv defconfig configs/
          # 5. æ‰§è¡Œmake defconfigï¼ŒæŒ‡å®šåŠ è½½è‡ªå®šä¹‰çš„defconfig
          make defconfig V=s CONFIG_DEFCONFIG=configs/defconfig
          # 6. æœ€ç»ˆéªŒè¯ï¼šç¡®ä¿è‡ªå®šä¹‰é…ç½®æœªè¢«è¦†ç›–
          if grep -q "CONFIG_PACKAGE_luci-base=y" .config; then
            echo "âœ… è‡ªå®šä¹‰é…ç½®é”å®šæˆåŠŸï¼Œæœªè¢«OpenWrté»˜è®¤é…ç½®è¦†ç›–"
          else
            echo "âŒ è‡ªå®šä¹‰é…ç½®è¢«è¦†ç›–ï¼Œæ„å»ºç»ˆæ­¢"
            cat .config && exit 1
          fi
          echo "âœ… è‡ªå®šä¹‰é…ç½®å·²æ ‡å‡†åŒ–ï¼ŒCCACHE 10Gåˆå§‹åŒ–å®Œæˆï¼ˆæ‰€æœ‰é—®é¢˜ä¿®å¤ï¼‰"

      - name: Build toolchain (ä¸è‡ªå®šä¹‰é…ç½®åŒ¹é…ï¼Œè§£è€¦ç¼–è¯‘)
        working-directory: openwrt
        run: |
          # ä¿å®ˆå¹¶å‘æ•°ï¼Œé¿å…OOMï¼›å¼€å¯CCACHEï¼Œæå‡ç¼–è¯‘æ•ˆç‡
          make toolchain/install -j$(nproc) V=s CCACHE=1 | tee toolchain-build.log
          # ç»Ÿè®¡ccacheä½¿ç”¨æƒ…å†µï¼Œæ’æŸ¥ç¼“å­˜ç”Ÿæ•ˆé—®é¢˜
          ccache -s
          echo "âœ… å·¥å…·é“¾æ„å»ºå®Œæˆ"

      - name: Build SL3000 eMMC firmware (é˜²OOM+å®Œæ•´æ—¥å¿—+CCACHEåŠ é€Ÿ)
        working-directory: openwrt
        run: |
          # å¹¶å‘æ•°é€‚é…2æ ¸4G Runnerï¼Œé¿å…OOMï¼›å¼€å¯è°ƒè¯•+CCACHE
          make -j$(nproc) V=s CCACHE=1 CONFIG_DEBUG_SECTION_MISMATCH=y | tee firmware-build.log
          # å†æ¬¡ç»Ÿè®¡ccacheï¼ŒæŸ¥çœ‹ç¼“å­˜å‘½ä¸­ç‡
          ccache -s
          echo "âœ… å›ºä»¶ç¼–è¯‘å®Œæˆ"

      - name: Upload all build logs (æ–¹ä¾¿äº‘æ„å»ºæ’é”™ï¼Œä¿ç•™7å¤©)
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-build-logs
          path: |
            openwrt/toolchain-build.log
            openwrt/firmware-build.log
            openwrt/sl3000-tools/sl3000-three-piece-generate.log
          retention-days: 7

      - name: Upload firmware artifacts (å®Œæ•´äº§ç‰©ï¼Œä¿ç•™30å¤©)
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-sl3000-emmc-firmware
          path: openwrt/bin/targets/mediatek/filogic/
          retention-days: 30

      - name: Auto Release firmware (ä»…æ„å»ºæˆåŠŸæ—¶å‘å¸ƒï¼Œé¢„å‘å¸ƒæ ‡è®°)
        uses: softprops/action-gh-release@v2
        if: success()  # ä»…ç¼–è¯‘æˆåŠŸæ‰æ‰§è¡Œå‘å¸ƒï¼Œé¿å…ç©ºåŒ…
        with:
          tagname: sl3000-emmc-build-${{ github.run_number }}-${{ github.run_id }}
          name: SL3000 eMMC Firmware #${{ github.run_number }}
          body: |
            ğŸš€ è‡ªåŠ¨æ„å»ºï¼šå¸ç»œSL3000 (MT7981B eMMC)
            ğŸ“Œ æºç ä»“åº“ï¼šykm888/immortalwrt-sl3000 (main)
            ğŸ›  è‡ªåŠ¨ç”Ÿæˆä¸‰ä»¶å¥—(DTS/MK/CONFIG)ï¼Œå·¥ç¨‹çº§æ——èˆ°ç‰ˆé…ç½®
            ğŸ“¦ å†…ç½®ï¼šDocker/Passwall2/SSR Plus+/eMMCæ–‡ä»¶ç³»ç»Ÿå…¨æ”¯æŒ
            ğŸ“ æ„å»ºæ—¥å¿—ï¼šæŸ¥çœ‹Artifacts â†’ sl3000-build-logs
            âš™ï¸ å†…æ ¸ç‰ˆæœ¬ï¼šLinux 6.6 (ImmortalWrt 24.10)
            âœ… å·²ä¿®å¤ï¼šconfigsç›®å½•ç¼ºå¤±/ccache 10Gæœªç”Ÿæ•ˆ/é…ç½®è¢«è¦†ç›–/æ‰€æœ‰ä¾èµ–è­¦å‘Š
          files: openwrt/bin/targets/mediatek/filogic/*
          prerelease: true  # é¢„å‘å¸ƒæ ‡è®°ï¼Œé¿å…æ­£å¼ç‰ˆæ±¡æŸ“
          draft: false
