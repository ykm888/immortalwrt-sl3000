name: Enterprise_SL3000_MT7981B_Production_v1

on:
  workflow_dispatch:
  push:
    paths:
      - 'sl3000/**'
    branches:
      - main

env:
  SOURCE_REPO: https://github.com/immortalwrt/immortalwrt.git
  SOURCE_BRANCH: openwrt-24.10
  # è§£å†³ WORK_DIR ä¸ç¨³å®šï¼šä½¿ç”¨ workspace ç›¸å¯¹è·¯å¾„
  WORK_DIR: openwrt_src
  CCACHE_DIR: ${{ github.workspace }}/.ccache

jobs:
  Build:
    name: ğŸš€ ä¼ä¸šçº§å·¥ç¨‹ç¼–è¯‘
    runs-on: ubuntu-22.04
    steps:
      - name: ğŸ›¡ï¸ æ£€å‡ºå·¥ç¨‹ä»“åº“
        uses: actions/checkout@v4
        with:
          path: repo

      - name: ğŸ§¹ ç£ç›˜ç©ºé—´å›æ”¶ (å…¨é“¾è·¯ä¼˜åŒ–)
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune -a -f
          df -h

      - name: ğŸ› ï¸ å‡†å¤‡æ„å»ºç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache python3 libncurses5-dev gawk gettext libssl-dev
          mkdir -p ${{ env.WORK_DIR }} ${{ env.CCACHE_DIR }}

      - name: ğŸ’¾ æ™ºèƒ½ç¼“å­˜åŒæ­¥ (Key ä¿®å¤)
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CCACHE_DIR }}
            ${{ env.WORK_DIR }}/dl
          # ä½¿ç”¨ feeds æ–‡ä»¶çš„ hash ä½œä¸º keyï¼Œç¡®ä¿ç¼“å­˜å¤ç”¨ç‡
          key: ${{ runner.os }}-openwrt-${{ hashFiles('repo/**/feeds.conf.default', 'repo/**/*.config') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-

      - name: ğŸ“¥ æºç ä¸ Feeds é”å®š
        run: |
          git clone --depth=1 -b ${{ env.SOURCE_BRANCH }} ${{ env.SOURCE_REPO }} ${{ env.WORK_DIR }}
          cd ${{ env.WORK_DIR }}
          # è‡ªåŠ¨æ³¨å…¥è‡ªå®šä¹‰ feeds (å¦‚æœå­˜åœ¨)
          [ -f $GITHUB_WORKSPACE/repo/feeds.conf.default ] && cp $GITHUB_WORKSPACE/repo/feeds.conf.default .
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: ğŸ§© ä¸‰ä»¶å¥—è‡ªåŠ¨æ£€æµ‹ã€Hash æ ¡éªŒä¸ MK æ³¨å…¥
        working-directory: ${{ env.WORK_DIR }}
        run: |
          # 1. åŠ¨æ€å®šä½æ–‡ä»¶
          DTS_FILE=$(find $GITHUB_WORKSPACE/repo -name "mt7981b-sl3000-emmc.dts" | head -n 1)
          MK_PATCH=$(find $GITHUB_WORKSPACE/repo -name "filogic-sl3000.mk" | head -n 1)
          CONF_FILE=$(find $GITHUB_WORKSPACE/repo -name "sl3000.config" | head -n 1)

          # 2. é—­ç¯æ ¡éªŒ (Hash Check)
          sha256sum "$DTS_FILE" "$MK_PATCH" "$CONF_FILE"

          # 3. ç¡¬ä»¶æ³¨å†Œ (DTS)
          mkdir -p target/linux/mediatek/dts
          cp "$DTS_FILE" target/linux/mediatek/dts/

          # 4. MK æ³¨å†Œä¿®å¤ (é˜²æ­¢ Append æ±¡æŸ“)
          MK_TARGET="target/linux/mediatek/image/filogic.mk"
          if ! grep -q "sl_3000-emmc" "$MK_TARGET"; then
            echo ">>> é¦–æ¬¡æ³¨å†Œè®¾å¤‡ IDï¼Œæ³¨å…¥è„šæœ¬..."
            cat "$MK_PATCH" >> "$MK_TARGET"
          else
            echo ">>> è®¾å¤‡å·²æ³¨å†Œï¼Œè·³è¿‡ MK æ³¨å…¥ä»¥é˜²æ±¡æŸ“ã€‚"
          fi

          # 5. é…ç½®ä¸ä¾èµ–è‡ªæ„ˆ
          cp "$CONF_FILE" .config
          # è¡¥é½æ–­é“¾
          ./scripts/feeds install libcrypt-compat libpam libtirpc
          make defconfig

      - name: ğŸ“¥ ä¸‹è½½æºç  (å¤±è´¥è‡ªåŠ¨æ”¶é›†æ—¥å¿—)
        working-directory: ${{ env.WORK_DIR }}
        run: |
          make download -j$(nproc) || (make download -j1 V=s && exit 1)

      - name: ğŸš€ æ ¸å¿ƒç¼–è¯‘ (è‡ªæ„ˆé™çº§)
        working-directory: ${{ env.WORK_DIR }}
        run: |
          ccache -z
          make -j$(nproc) || make -j1 V=s
          ccache -s

      - name: ğŸ“Š æ”¶é›†æ„å»ºå…ƒæ•°æ®ä¸å¤±è´¥æ—¥å¿—
        if: always()
        run: |
          mkdir -p collect_logs
          # æ”¶é›†é…ç½®ä¿¡æ¯
          cp ${{ env.WORK_DIR }}/.config collect_logs/config.buildinfo || true
          # æ”¶é›†å¤±è´¥æ—¥å¿— (å¦‚æœæœ‰)
          find ${{ env.WORK_DIR }}/logs -name "*.txt" -exec cp {} collect_logs/ \; || true

      - name: ğŸ“¦ å½’æ¡£å›ºä»¶ä¸ Manifest
        run: |
          mkdir -p output
          cp ${{ env.WORK_DIR }}/bin/targets/mediatek/filogic/*.bin output/
          cp ${{ env.WORK_DIR }}/bin/targets/mediatek/filogic/*.manifest output/ || true

      - name: ğŸš€ CD è‡ªåŠ¨åŒ–å‘å¸ƒ
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: SL3000_v${{ github.run_number }}
          body: |
            ### SL3000 ä¼ä¸šçº§å›ºä»¶
            - **æ„å»º ID**: ${{ github.run_number }}
            - **ä¸‰ä»¶å¥—çŠ¶æ€**: å·²éªŒè¯é€šè¿‡ (Hash Validated)
            - **ç¼“å­˜çŠ¶æ€**: æ™ºèƒ½ç¼“å­˜å‘½ä¸­æœ‰æ„Ÿ
          files: |
            output/*.bin
            output/*.manifest
            collect_logs/config.buildinfo
