name: build-sl3000-2410-final

on:
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          path: repo

      - name: 磁盘环境初始化
        run: |
          sudo mkdir -p /mnt/openwrt
          sudo chown -R $USER:$USER /mnt
          rm -rf /mnt/openwrt/* || true

      - name: 安装依赖与 ccache
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache python3 libncurses5-dev gawk gettext libssl-dev
          echo "CCACHE_DIR=/mnt/openwrt/.ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=2G" >> $GITHUB_ENV

      - name: 缓存 ccache
        uses: actions/cache@v4
        with:
          path: /mnt/openwrt/.ccache
          key: ${{ runner.os }}-2410-ccache-${{ github.sha }}
          restore-keys: ${{ runner.os }}-2410-ccache-

      - name: 克隆源码 (ImmortalWrt 24.10)
        run: git clone --depth=1 -b openwrt-24.10 https://github.com/immortalwrt/immortalwrt.git /mnt/openwrt

      - name: 更新 Feeds 索引
        working-directory: /mnt/openwrt
        run: |
          rm -f feeds.conf feeds.conf.default
          echo 'src-git packages https://github.com/openwrt/packages.git' > feeds.conf.default
          echo 'src-git luci https://github.com/openwrt/luci.git' >> feeds.conf.default
          echo 'src-git helloworld https://github.com/fw876/helloworld.git' >> feeds.conf.default
          echo 'src-git small https://github.com/kenzok8/small.git' >> feeds.conf.default
          ./scripts/feeds update -a

      - name: 执行强力清理与补全依赖
        working-directory: /mnt/openwrt
        run: |
          # 1. 剔除主树冲突包
          CONFLICTS="package/system/refpolicy package/system/selinux-policy package/utils/policycoreutils package/utils/pcat-manager package/network/services/lldpd package/boot/kexec-tools package/emortal/default-settings package/libs/libpam package/libs/libtirpc package/libs/libnsl package/libs/xz"
          for p in $CONFLICTS; do rm -rf $p; done
          
          # 2. 重置 feeds 目录
          rm -rf package/feeds && mkdir -p package/feeds
          
          # 3. 补全核心依赖（解决卡死关键）
          ./scripts/feeds install -p packages libpam libtirpc libev libnsl xz lm-sensors wsdd2 attr
          ./scripts/feeds install -p luci luci-base luci-compat luci-lua-runtime luci-lib-ip luci-lib-jsonc luci-theme-bootstrap

      - name: 应用三件套 (DTS/MK/Config)
        working-directory: /mnt/openwrt
        run: |
          # 查找并应用 DTS
          DTS_PATH=$(find $GITHUB_WORKSPACE/repo -name "mt7981b-sl3000-emmc.dts" | head -n 1)
          mkdir -p target/linux/mediatek/dts
          [ -n "$DTS_PATH" ] && cp "$DTS_PATH" target/linux/mediatek/dts/
          
          # 查找并应用 MK (自愈追加)
          MK_PATH=$(find $GITHUB_WORKSPACE/repo -name "filogic-sl3000.mk" | head -n 1)
          MK_TARGET="target/linux/mediatek/image/filogic.mk"
          if [ -n "$MK_PATH" ]; then
            grep -q "sl_3000-emmc" "$MK_TARGET" || cat "$MK_PATH" >> "$MK_TARGET"
          fi
          
          # 查找并应用 Config
          CONF_PATH=$(find $GITHUB_WORKSPACE/repo -name "sl3000.config" | head -n 1)
          [ -n "$CONF_PATH" ] && cp "$CONF_PATH" .config
          
          # 刷新配置
          make defconfig

      - name: 下载源码 (自愈)
        working-directory: /mnt/openwrt
        run: |
          make download -j$(nproc) || make download -j1 V=s
          find dl -type f -size 0 -delete

      - name: 完整构建 (自愈体系)
        working-directory: /mnt/openwrt
        run: |
          # 自动处理依赖链构建
          make -j$(nproc) || make -j1 V=s

      - name: 上传固件
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-firmware
          path: /mnt/openwrt/bin/targets/mediatek/filogic/*.bin

      - name: 自动发布
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: sl3000-v24.10-${{ github.run_number }}
          files: /mnt/openwrt/bin/targets/mediatek/filogic/*.bin
