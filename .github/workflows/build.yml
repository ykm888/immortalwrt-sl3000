name: Build ImmortalWrt SL3000 eMMC (Auto Three-Piece)

on:
  workflow_dispatch:

# å…¨å±€æƒé™ï¼šæ»¡è¶³ä»£ç æ¨é€ã€Releaseå‘å¸ƒã€Artifactä¸Šä¼ ã€ä»“åº“æ‹‰å–
permissions:
  contents: write
  actions: read
  packages: write

jobs:
  build-sl3000-firmware:
    runs-on: ubuntu-22.04
    timeout-minutes: 360  # å»¶é•¿è¶…æ—¶æ—¶é—´ï¼Œé€‚é…MT7981Bå›ºä»¶å®Œæ•´ç¼–è¯‘
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout local repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: repo  # æ˜¾å¼æŒ‡å®šè·¯å¾„ï¼Œé¿å…ä¸openwrtç›®å½•å†²çª

      - name: Optimize disk space (Ubuntu 22.04 Runner)
        run: |
          # å¸è½½æ— ç”¨ç»„ä»¶ï¼Œé‡Šæ”¾è¶…20Gç£ç›˜ç©ºé—´
          sudo apt-get remove -y --purge azure-cli google-cloud-sdk dotnet powershell mono mysql-server php* android* snapd || true
          sudo apt-get autoremove -y --purge
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/* /usr/share/doc /usr/share/man
          # æ·»åŠ 10G swapåˆ†åŒºï¼Œè§£å†³ç¼–è¯‘OOMæ ¸å¿ƒé—®é¢˜
          sudo fallocate -l 10G /swapfile && sudo mkswap /swapfile && sudo swapon /swapfile
          free -h && df -h

      - name: Install build dependencies (é€‚é…ImmortalWrt 24.10/Linux 6.6)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential git-core libncurses5-dev \
            zlib1g-dev gawk flex gettext wget unzip python3 python3-distutils \
            file libssl-dev rsync ccache device-tree-compiler subversion libelf-dev \
            bc bison patch gcc-multilib g++-multilib swig libudev-dev libusb-1.0-0-dev

      - name: Clone your ImmortalWrt source (ç²¾å‡†å¯¹é½ ykm888/immortalwrt-sl3000)
        run: |
          # å®¹é”™åˆ é™¤æ—§ç›®å½•ï¼Œé¿å…æƒé™/æ®‹ç•™å†²çª
          sudo rm -rf openwrt || true
          # æ‹‰å–ä½ çš„ä»“åº“æº + mainåˆ†æ”¯ï¼ˆè´´åˆè¯¥ä»“åº“é»˜è®¤åˆ†æ”¯ï¼‰
          git clone --depth=1 -b main https://github.com/ykm888/immortalwrt-sl3000.git openwrt
          cd openwrt
          # åˆå§‹åŒ–å­æ¨¡å—ï¼Œé¿å…æºç ç¼ºå¤±
          git submodule update --init --recursive || true
          echo "âœ… ä»“åº“æ‹‰å–å®Œæˆï¼šykm888/immortalwrt-sl3000 (main)"

      - name: Cache downloads & ccache (cloneåæ‰§è¡Œï¼Œç¼“å­˜100%ç”Ÿæ•ˆ)
        uses: actions/cache@v4
        with:
          path: |
            openwrt/dl
            openwrt/.ccache
          key: ${{ runner.os }}-sl3000-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-sl3000-

      - name: Copy SL3000 tools & add execute permission (æ ¸å¿ƒä¿®å¤)
        run: |
          # ä»æœ¬åœ°repoå¤åˆ¶å·¥å…·åˆ°openwrtæ„å»ºç›®å½•
          cp -r repo/sl3000-tools openwrt/
          # ç»™å·¥å…·ç›®å½•ä¸‹ALL .shè„šæœ¬åŠ æ‰§è¡Œæƒé™ï¼Œå½»åº•è§£å†³æƒé™é—®é¢˜
          chmod +x openwrt/sl3000-tools/*.sh
          ls -l openwrt/sl3000-tools/
          echo "âœ… å·¥å…·å¤åˆ¶å®Œæˆï¼Œæ‰€æœ‰è„šæœ¬å·²æˆæƒæ‰§è¡Œ"

      - name: Update & install ImmortalWrt feeds (å®¹é”™+å®Œæ•´å®‰è£…)
        working-directory: openwrt
        run: |
          ./scripts/feeds update -a --force || true
          ./scripts/feeds install -a -f || true
          ./scripts/feeds clean || true
          echo "âœ… Feedsæ›´æ–°&å®‰è£…å®Œæˆ"

      - name: Generate SL3000 Three-Piece Set (è¿è¡Œä½ çš„ç”Ÿæˆè„šæœ¬)
        working-directory: openwrt
        run: |
          # æ‰§è¡Œä¸‰ä»¶å¥—ç”Ÿæˆè„šæœ¬ï¼Œè‡ªåŠ¨ç”ŸæˆDTS/MK/CONFIGï¼ˆå·²ä¿®å¤ä¾èµ–è­¦å‘Šï¼‰
          ./sl3000-tools/generate-three-piece.sh
          # éªŒè¯DTSç”Ÿæˆç»“æœï¼Œå¿«é€Ÿæ’æŸ¥è·¯å¾„/æ–‡ä»¶é—®é¢˜
          if [ -f "target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts" ]; then
            echo "âœ… DTSç”ŸæˆæˆåŠŸï¼Œæ–‡ä»¶å­˜åœ¨"
            head -20 target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts
          else
            echo "âŒ DTSç”Ÿæˆå¤±è´¥ï¼Œæ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

      - name: Normalize config & init CCACHE (æ ¸å¿ƒä¿®å¤ï¼šè§£å†³.ccache/ccache.confä¸å­˜åœ¨)
        working-directory: openwrt
        run: |
          # ç¬¬ä¸€æ­¥ï¼šæå‰åˆ›å»º.ccacheç›®å½•ï¼Œé¿å…é…ç½®æ–‡ä»¶å†™å…¥å¤±è´¥ï¼ˆè‡´å‘½é”™è¯¯ä¿®å¤ï¼‰
          mkdir -p .ccache
          chmod 777 .ccache
          # ç¬¬äºŒæ­¥ï¼šé…ç½®ccacheç¼“å­˜å¤§å°ï¼Œé€‚é…äº‘æ„å»ºç£ç›˜é™åˆ¶
          echo 'max_size = 10G' > .ccache/ccache.conf
          echo 'compression = true' >> .ccache/ccache.conf
          echo 'cache_dir = .ccache' >> .ccache/ccache.conf
          # ç¬¬ä¸‰æ­¥ï¼šåˆå§‹åŒ–ccacheï¼Œæ¸…ç©ºæ—§ç¼“å­˜/ç»Ÿè®¡
          ccache -C && ccache -z && ccache -s
          # ç¬¬å››æ­¥ï¼šåŠ è½½è‡ªå®šä¹‰.configå¹¶æ ‡å‡†åŒ–ï¼Œè¦†ç›–é»˜è®¤é…ç½®
          make defconfig V=s
          echo "âœ… è‡ªå®šä¹‰é…ç½®å·²æ ‡å‡†åŒ–ï¼ŒCCACHEåˆå§‹åŒ–å®Œæˆï¼ˆè§£å†³é…ç½®æ–‡ä»¶ä¸å­˜åœ¨é”™è¯¯ï¼‰"

      - name: Build toolchain (ä¸è‡ªå®šä¹‰é…ç½®åŒ¹é…ï¼Œè§£è€¦ç¼–è¯‘)
        working-directory: openwrt
        run: |
          # æ„å»ºå·¥å…·é“¾ï¼Œå•ç‹¬è§£è€¦æå‡åç»­ç¼–è¯‘æ•ˆç‡ï¼›ä¿å®ˆå¹¶å‘ï¼Œé¿å…OOM
          make toolchain/install -j$(nproc) V=s | tee toolchain-build.log
          # ç»Ÿè®¡ccacheä½¿ç”¨æƒ…å†µï¼Œæ’æŸ¥ç¼“å­˜ç”Ÿæ•ˆé—®é¢˜
          ccache -s
          echo "âœ… å·¥å…·é“¾æ„å»ºå®Œæˆ"

      - name: Build SL3000 eMMC firmware (é˜²OOM+å®Œæ•´æ—¥å¿—)
        working-directory: openwrt
        run: |
          # ä¿å®ˆå¹¶å‘æ•°ï¼ˆé€‚é…2æ ¸4G Runnerï¼‰ï¼Œå½»åº•é¿å…OOMï¼›å¼€å¯è°ƒè¯•ï¼Œæ•è·æ‰€æœ‰æ—¥å¿—
          make -j$(nproc) V=s CONFIG_DEBUG_SECTION_MISMATCH=y | tee firmware-build.log
          # å†æ¬¡ç»Ÿè®¡ccacheï¼ŒæŸ¥çœ‹ç¼“å­˜å‘½ä¸­ç‡
          ccache -s
          echo "âœ… å›ºä»¶ç¼–è¯‘å®Œæˆ"

      - name: Upload all build logs (æ–¹ä¾¿äº‘æ„å»ºæ’é”™)
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-build-logs
          path: |
            openwrt/toolchain-build.log
            openwrt/firmware-build.log
            openwrt/sl3000-tools/sl3000-three-piece-generate.log
          retention-days: 7  # æ—¥å¿—ä¿ç•™7å¤©ï¼Œå¯æŒ‰éœ€è°ƒæ•´

      - name: Upload firmware artifacts (å®Œæ•´äº§ç‰©)
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-sl3000-emmc-firmware
          path: openwrt/bin/targets/mediatek/filogic/
          retention-days: 30  # å›ºä»¶ä¿ç•™30å¤©

      - name: Auto Release firmware (ä»…æ„å»ºæˆåŠŸæ—¶å‘å¸ƒ)
        uses: softprops/action-gh-release@v2
        if: success()  # ä»…ç¼–è¯‘æˆåŠŸæ‰æ‰§è¡Œå‘å¸ƒï¼Œé¿å…ç©ºåŒ…
        with:
          tagname: sl3000-emmc-build-${{ github.run_number }}-${{ github.run_id }}
          name: SL3000 eMMC Firmware #${{ github.run_number }}
          body: |
            ğŸš€ è‡ªåŠ¨æ„å»ºï¼šå¸ç»œSL3000 (MT7981B eMMC)
            ğŸ“Œ æºç ä»“åº“ï¼šykm888/immortalwrt-sl3000 (main)
            ğŸ›  è‡ªåŠ¨ç”Ÿæˆä¸‰ä»¶å¥—(DTS/MK/CONFIG)ï¼Œå·¥ç¨‹çº§æ——èˆ°ç‰ˆé…ç½®
            ğŸ“¦ å†…ç½®ï¼šDocker/Passwall2/SSR Plus+/eMMCæ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
            ğŸ“ æ„å»ºæ—¥å¿—ï¼šæŸ¥çœ‹Artifacts â†’ sl3000-build-logs
            âš™ï¸ å†…æ ¸ç‰ˆæœ¬ï¼šLinux 6.6 (ImmortalWrt 24.10)
            âœ… ä¿®å¤ï¼šCCACHEé…ç½®ç¼ºå¤±/ä¾èµ–ç¼ºå¤±è­¦å‘Š/DTSè¯­æ³•/ä¹±ç 
          files: openwrt/bin/targets/mediatek/filogic/*
          prerelease: true  # é¢„å‘å¸ƒæ ‡è®°ï¼Œé¿å…æ­£å¼ç‰ˆæ±¡æŸ“
          draft: false
