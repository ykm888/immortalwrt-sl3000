name: build-sl3000-openwrt-2410

on:
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build-sl3000-2410:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Skip auto-run when workflow file is modified
        if: github.event_name == 'push' && contains(join(github.event.commits.*.modified), '.github/workflows/')
        run: |
          echo "Workflow file modified. Skipping auto-run."
          exit 0

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Prepare disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          sudo apt-get update
          sudo apt-get autoremove -y
          sudo apt-get clean

      - name: Prepare /mnt/openwrt
        run: |
          sudo mkdir -p /mnt/openwrt
          sudo chown -R $USER:$USER /mnt
          mkdir -p /mnt/openwrt

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gawk flex gettext git-core libssl-dev rsync unzip python3

      - name: Clone ImmortalWrt 24.10
        run: |
          rm -rf /mnt/openwrt
          git clone --depth=1 -b openwrt-24.10 https://github.com/immortalwrt/immortalwrt.git /mnt/openwrt

      - name: Update feeds
        working-directory: /mnt/openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # ============================================================
      # DTS
      # ============================================================

      - name: Generate DTS
        working-directory: /mnt/openwrt
        run: |
          mkdir -p target/linux/mediatek/dts
          DTS=target/linux/mediatek/dts/mt7981b-sl-3000-emmc.dts
          : > "$DTS"
          echo "/dts-v1/;" >> "$DTS"
          echo "#include \"mt7981.dtsi\"" >> "$DTS"
          echo "/ { model = \"SL3000\"; compatible = \"sl,3000-emmc\"; };" >> "$DTS"

      # ============================================================
      # MK
      # ============================================================

      - name: Generate MK
        working-directory: /mnt/openwrt
        run: |
          MK=target/linux/mediatek/image/filogic.mk
          sed -i '/Device\/sl_3000-emmc/,/endef/d' "$MK"
          sed -i '/TARGET_DEVICES += sl3000-emmc/d' "$MK"

          echo "" >> "$MK"
          echo "define Device/sl_3000-emmc" >> "$MK"
          echo "  DEVICE_VENDOR := SL" >> "$MK"
          echo "  DEVICE_MODEL := 3000 eMMC" >> "$MK"
          echo "  DEVICE_DTS := mt7981b-sl-3000-emmc" >> "$MK"
          echo "  DEVICE_DTS_DIR := ../dts" >> "$MK"
          echo "endef" >> "$MK"
          echo "TARGET_DEVICES += sl3000-emmc" >> "$MK"

      # ============================================================
      # defconfig
      # ============================================================

      - name: Base defconfig
        working-directory: /mnt/openwrt
        run: make defconfig

      # ============================================================
      # CONFIG
      # ============================================================

      - name: Generate CONFIG
        working-directory: /mnt/openwrt
        run: |
          CFG=/mnt/openwrt/.config
          sed -i '/CONFIG_TARGET_DEVICE_mediatek_mt7981_DEVICE_sl_3000-emmc/d' "$CFG"
          echo "CONFIG_TARGET_DEVICE_mediatek_mt7981_DEVICE_sl_3000-emmc=y" >> "$CFG"

      # ============================================================
      # 校验（关键步骤）
      # ============================================================

      - name: Validate SL3000 three-piece set
        working-directory: /mnt/openwrt
        run: |
          DTS=target/linux/mediatek/dts/mt7981b-sl-3000-emmc.dts
          MK=target/linux/mediatek/image/filogic.mk
          CFG=/mnt/openwrt/.config

          echo "=== Check DTS ==="
          [ -s "$DTS" ] || { echo "[FATAL] DTS missing"; exit 1; }

          echo "=== Check MK ==="
          grep -q "Device/sl_3000-emmc" "$MK" || { echo "[FATAL] MK missing device"; exit 1; }

          echo "=== Check CONFIG ==="
          grep -q "CONFIG_TARGET_DEVICE_mediatek_mt7981_DEVICE_sl_3000-emmc=y" "$CFG" \
            || { echo "[FATAL] CONFIG missing device enable"; exit 1; }

      # ============================================================
      # 构建
      # ============================================================

      - name: Build
        working-directory: /mnt/openwrt
        run: make -j$(nproc)

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-firmware
          path: /mnt/openwrt/bin/targets/mediatek/mt7981/*
