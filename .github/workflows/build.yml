name: Enterprise_SL3000_Decoupled_v7

on:
  workflow_dispatch:

env:
  WORK_DIR: ${{ github.workspace }}/openwrt_src
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  SOURCE_REPO: https://github.com/immortalwrt/immortalwrt.git
  SOURCE_BRANCH: openwrt-24.10

jobs:
  # --- 阶段一：Tools ---
  Build_Tools:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Cleanup & Init
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/node_modules
          mkdir -p ${{ env.WORK_DIR }}

      - name: Tools Cache
        id: tools-cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.WORK_DIR }}/staging_dir/host
            ${{ env.WORK_DIR }}/feeds
            ${{ env.WORK_DIR }}/feeds.lock
          key: ${{ runner.os }}-tools-${{ env.SOURCE_BRANCH }}-${{ hashFiles('repo/feeds.conf.default') }}

      - name: Build Tools
        if: steps.tools-cache.outputs.cache-hit != 'true'
        working-directory: ${{ env.WORK_DIR }}
        run: |
          git clone --depth=1 -b ${{ env.SOURCE_BRANCH }} ${{ env.SOURCE_REPO }} .
          cp $GITHUB_WORKSPACE/repo/feeds.conf.default feeds.conf.default
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          cp -v feeds.conf.default feeds.lock
          make tools/install -j$(nproc) || make tools/install -j1 V=s

  # --- 阶段二：Toolchain ---
  Build_Toolchain:
    needs: Build_Tools
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Toolchain Cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.WORK_DIR }}/staging_dir
            ${{ env.WORK_DIR }}/feeds
            ${{ env.WORK_DIR }}/feeds.lock
          key: ${{ runner.os }}-toolchain-${{ hashFiles('repo/sl3000/sl3000.config', 'repo/feeds.conf.default', 'repo/sl3000/mt7981b-sl3000-emmc.dts', 'repo/sl3000/filogic-sl3000.mk') }}

      - name: Build Toolchain
        working-directory: ${{ env.WORK_DIR }}
        run: |
          mkdir -p ${{ env.WORK_DIR }}
          [ -d .git ] || git clone --depth=1 -b ${{ env.SOURCE_BRANCH }} ${{ env.SOURCE_REPO }} .
          cp $GITHUB_WORKSPACE/repo/feeds.conf.default feeds.conf.default
          bash $GITHUB_WORKSPACE/repo/scripts/clean-feeds.sh
          make toolchain/install -j$(nproc) || make toolchain/install -j1 V=s

  # --- 阶段三：Target ---
  Build_Target:
    needs: Build_Toolchain
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Restore Build Cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.WORK_DIR }}/staging_dir
            ${{ env.WORK_DIR }}/dl
            ${{ env.CCACHE_DIR }}
            ${{ env.WORK_DIR }}/feeds
            ${{ env.WORK_DIR }}/feeds.lock
          key: ${{ runner.os }}-target-${{ hashFiles('repo/sl3000/sl3000.config', 'repo/feeds.conf.default', 'repo/sl3000/mt7981b-sl3000-emmc.dts', 'repo/sl3000/filogic-sl3000.mk') }}

      - name: Build Target
        working-directory: ${{ env.WORK_DIR }}
        run: |
          mkdir -p ${{ env.WORK_DIR }}
          [ -d .git ] || git clone --depth=1 -b ${{ env.SOURCE_BRANCH }} ${{ env.SOURCE_REPO }} .
          cp $GITHUB_WORKSPACE/repo/feeds.conf.default feeds.conf.default

          export CCACHE_DIR=${{ env.CCACHE_DIR }}
          export CC="ccache gcc"
          export CXX="ccache g++"

          bash $GITHUB_WORKSPACE/repo/scripts/clean-feeds.sh

          make download -j$(nproc) || make download -j1 V=s
          find dl -type f -size 0 -delete

          ccache -z || true
          make -j$(nproc) || make -j1 V=s
          ccache -s || true

      - name: Collect Artifacts
        run: |
          mkdir -p output logs
          cp ${{ env.WORK_DIR }}/bin/targets/mediatek/filogic/*sl* output/ || true
          cp ${{ env.WORK_DIR }}/bin/targets/mediatek/filogic/*.manifest output/ || true
          cp ${{ env.WORK_DIR }}/bin/targets/mediatek/filogic/sha256sums logs/ || true
          cp ${{ env.WORK_DIR }}/feeds.lock logs/ || true
          cp ${{ env.WORK_DIR }}/.config logs/config.buildinfo || true

      - name: Release Firmware
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: SL3000_Decoupled_v${{ github.run_number }}
          files: |
            output/*
            logs/*
