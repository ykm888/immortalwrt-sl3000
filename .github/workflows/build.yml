name: Build SL3000-EMMC Firmware

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Prepare build environment
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev

    - name: Clone ImmortalWrt
      run: |
        git clone https://github.com/immortalwrt/immortalwrt.git openwrt
        cd openwrt
        git checkout openwrt-24.10

    - name: Force clean feeds (一次性彻底重置)
      working-directory: openwrt
      run: |
        rm -rf feeds
        rm -rf package/feeds

    - name: Update feeds
      working-directory: openwrt
      run: ./scripts/feeds update -a

    - name: Install feeds
      working-directory: openwrt
      run: ./scripts/feeds install -a

    - name: Apply three-piece (DTS / MK / CONFIG)
      working-directory: openwrt
      run: |
        cp $GITHUB_WORKSPACE/repo/sl3000/dts/mt7981b-sl3000-emmc.dts target/linux/mediatek/dts/
        cat $GITHUB_WORKSPACE/repo/sl3000/mk/filogic-sl3000.mk >> target/linux/mediatek/image/filogic.mk
        rm -f .config
        cp $GITHUB_WORKSPACE/repo/sl3000/config/sl3000.config .config
        make defconfig

    - name: Clean feeds (最终版)
      working-directory: openwrt
      run: |
        chmod +x $GITHUB_WORKSPACE/repo/scripts/clean-feeds.sh
        bash $GITHUB_WORKSPACE/repo/scripts/clean-feeds.sh

    - name: Build toolchain
      working-directory: openwrt
      run: |
        make toolchain/install -j$(nproc) || make toolchain/install -j1 V=s

    - name: Build firmware
      working-directory: openwrt
      run: |
        make -j$(nproc) || make -j1 V=s

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: sl3000-emmc-firmware
        path: openwrt/bin/targets/mediatek/filogic/
