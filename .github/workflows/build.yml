name: build-sl3000-2410-fixed

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          path: repo

      - name: 磁盘环境初始化
        run: |
          sudo mkdir -p /mnt/openwrt
          sudo chown -R $USER:$USER /mnt
          rm -rf /mnt/openwrt/* || true

      - name: 安装依赖与 ccache
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache python3 libncurses5-dev gawk gettext libssl-dev
          echo "CCACHE_DIR=/mnt/openwrt/.ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=2G" >> $GITHUB_ENV

      - name: 克隆源码 (ImmortalWrt 24.10)
        run: git clone --depth=1 -b openwrt-24.10 https://github.com/immortalwrt/immortalwrt.git /mnt/openwrt

      - name: 配置 Feeds 源 (更新索引)
        working-directory: /mnt/openwrt
        run: |
          rm -f feeds.conf feeds.conf.default
          echo 'src-git packages https://github.com/openwrt/packages.git' > feeds.conf.default
          echo 'src-git luci https://github.com/openwrt/luci.git' >> feeds.conf.default
          echo 'src-git helloworld https://github.com/fw876/helloworld.git' >> feeds.conf.default
          echo 'src-git small https://github.com/kenzok8/small.git' >> feeds.conf.default
          ./scripts/feeds update -a

      - name: 运行清理逻辑与依赖补全
        working-directory: /mnt/openwrt
        run: |
          chmod +x $GITHUB_WORKSPACE/repo/scripts/clean-feeds.sh
          bash $GITHUB_WORKSPACE/repo/scripts/clean-feeds.sh

      - name: 应用三件套 (DTS/MK/Config)
        working-directory: /mnt/openwrt
        run: |
          # 1. 应用 DTS
          mkdir -p target/linux/mediatek/dts
          cp $GITHUB_WORKSPACE/repo/sl3000/dts/mt7981b-sl3000-emmc.dts target/linux/mediatek/dts/
          
          # 2. 应用 MK (自愈式追加)
          MK_FILE="target/linux/mediatek/image/filogic.mk"
          if ! grep -q "sl_3000-emmc" "$MK_FILE"; then
            cat $GITHUB_WORKSPACE/repo/sl3000/mk/filogic-sl3000.mk >> "$MK_FILE"
          fi
          
          # 3. 应用 Config 并生成最终配置
          cp $GITHUB_WORKSPACE/repo/sl3000/config/sl3000.config .config
          make defconfig

      - name: 下载源码 (自愈下载)
        working-directory: /mnt/openwrt
        run: |
          make download -j$(nproc) || make download -j1 V=s
          find dl -type f -size 0 -delete

      - name: 核心构建 (自愈体系)
        working-directory: /mnt/openwrt
        run: |
          # 采用合并构建，系统会自动处理 tools -> toolchain -> target
          # 多线程失败时自动切换单线程输出错误日志
          make -j$(nproc) || make -j1 V=s

      - name: 上传固件
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-2410-firmware
          path: /mnt/openwrt/bin/targets/mediatek/filogic/*.bin
