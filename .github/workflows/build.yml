name: Enterprise_SL3000_MT7981B_Production_v2

on:
  workflow_dispatch:
  push:
    paths:
      - 'sl3000/**'
    branches:
      - main

env:
  SOURCE_REPO: https://github.com/immortalwrt/immortalwrt.git
  SOURCE_BRANCH: openwrt-24.10
  WORK_DIR: ${{ github.workspace }}/openwrt_src
  CCACHE_DIR: ${{ github.workspace }}/.ccache

jobs:
  Build:
    name: ğŸš€ ä¼ä¸šçº§å·¥ç¨‹ç¼–è¯‘
    runs-on: ubuntu-22.04

    steps:
      - name: ğŸ›¡ï¸ æ£€å‡ºå·¥ç¨‹ä»“åº“
        uses: actions/checkout@v4
        with:
          path: repo

      - name: ğŸ§¹ ç£ç›˜ç©ºé—´å›æ”¶ (å…¨é“¾è·¯ä¼˜åŒ–)
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/lib/node_modules
          sudo docker image prune -a -f
          sudo rm -rf /var/lib/docker
          df -h

      - name: ğŸ› ï¸ å‡†å¤‡æ„å»ºç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache python3 libncurses5-dev gawk gettext libssl-dev rsync zip time
          mkdir -p ${{ env.WORK_DIR }} ${{ env.CCACHE_DIR }}

      - name: ğŸ’¾ æ™ºèƒ½ç¼“å­˜åŒæ­¥ (Key ä¿®å¤)
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CCACHE_DIR }}
            ${{ env.WORK_DIR }}/dl
          key: ${{ runner.os }}-openwrt-${{ hashFiles('repo/feeds.conf.default', 'repo/sl3000/sl3000.config') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-

      - name: ğŸ“¥ æºç ä¸ Feeds é”å®š
        run: |
          git clone --depth=1 -b ${{ env.SOURCE_BRANCH }} ${{ env.SOURCE_REPO }} ${{ env.WORK_DIR }}
          cd ${{ env.WORK_DIR }}

          # æ³¨å…¥è‡ªå®šä¹‰ feedsï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          [ -f $GITHUB_WORKSPACE/repo/feeds.conf.default ] && cp $GITHUB_WORKSPACE/repo/feeds.conf.default .

          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # ç”Ÿæˆ feeds.lockï¼ˆå¯å¤ç°æ€§æ ¸å¿ƒï¼‰
          ./scripts/feeds list -s > feeds.lock

      - name: ğŸ§© ä¸‰ä»¶å¥—è‡ªåŠ¨æ£€æµ‹ã€Hash æ ¡éªŒä¸ MK å®‰å…¨æ³¨å…¥
        working-directory: ${{ env.WORK_DIR }}
        run: |
          echo ">>> å¼€å§‹ä¸‰ä»¶å¥—é—­ç¯æ£€æµ‹..."

          DTS_FILE=$(find $GITHUB_WORKSPACE/repo -name "mt7981b-sl3000-emmc.dts" | head -n 1)
          MK_PATCH=$(find $GITHUB_WORKSPACE/repo -name "filogic-sl3000.mk" | head -n 1)
          CONF_FILE=$(find $GITHUB_WORKSPACE/repo -name "sl3000.config" | head -n 1)

          if [[ -z "$DTS_FILE" || -z "$MK_PATCH" || -z "$CONF_FILE" ]]; then
            echo "[ERROR] ä¸‰ä»¶å¥—ç¼ºå¤±ï¼Œç»ˆæ­¢æ„å»ºï¼"
            exit 1
          fi

          echo ">>> ä¸‰ä»¶å¥— Hash æ ¡éªŒï¼š"
          sha256sum "$DTS_FILE" "$MK_PATCH" "$CONF_FILE"

          # æ³¨å†Œ DTS
          mkdir -p target/linux/mediatek/dts
          cp "$DTS_FILE" target/linux/mediatek/dts/

          # MK å®‰å…¨æ’å…¥ï¼ˆæŒ‰æ®µè½ï¼Œä¸ appendï¼‰
          MK_TARGET="target/linux/mediatek/image/filogic.mk"
          if ! grep -q "Device/sl_3000-emmc" "$MK_TARGET"; then
            echo ">>> æ³¨å…¥ SL3000 è®¾å¤‡æ®µï¼ˆç»“æ„åŒ–æ’å…¥ï¼‰"
            awk -v patch="$MK_PATCH" '
              /define Device/ && !inserted {
                print; 
                while ((getline line < patch) > 0) print line;
                inserted=1; next
              }1
            ' "$MK_TARGET" > "$MK_TARGET.tmp"
            mv "$MK_TARGET.tmp" "$MK_TARGET"
          else
            echo ">>> SL3000 å·²æ³¨å†Œï¼Œè·³è¿‡ MK æ³¨å…¥"
          fi

          # æ³¨å†Œ Config
          cp "$CONF_FILE" .config

          # ä¾èµ–è¡¥é½
          ./scripts/feeds install libcrypt-compat libpam libtirpc

          make defconfig

      - name: ğŸ“¥ ä¸‹è½½æºç  (å¤±è´¥è‡ªåŠ¨æ”¶é›†æ—¥å¿—)
        working-directory: ${{ env.WORK_DIR }}
        run: |
          make download -j$(nproc) || make download -j1 V=s
          find dl -type f -size 0 -delete

      - name: ğŸš€ æ ¸å¿ƒç¼–è¯‘ (è‡ªæ„ˆé™çº§)
        working-directory: ${{ env.WORK_DIR }}
        run: |
          ccache -z
          make -j$(nproc) || make -j1 V=s
          ccache -s

      - name: ğŸ“Š æ”¶é›†æ„å»ºå…ƒæ•°æ®ä¸å¤±è´¥æ—¥å¿—
        if: always()
        run: |
          mkdir -p collect_logs
          cp ${{ env.WORK_DIR }}/.config collect_logs/config.buildinfo || true
          cp ${{ env.WORK_DIR }}/bin/targets/mediatek/filogic/sha256sums collect_logs/ || true
          find ${{ env.WORK_DIR }}/logs -name "*.txt" -exec cp {} collect_logs/ \; || true

      - name: ğŸ“¦ å½’æ¡£å›ºä»¶ä¸ Manifestï¼ˆå…¨æ ¼å¼æ”¯æŒï¼‰
        run: |
          mkdir -p output
          cp ${{ env.WORK_DIR }}/bin/targets/mediatek/filogic/*sl* output/ || true
          cp ${{ env.WORK_DIR }}/bin/targets/mediatek/filogic/*.manifest output/ || true

      - name: ğŸš€ CD è‡ªåŠ¨åŒ–å‘å¸ƒ
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: SL3000_v${{ github.run_number }}
          body: |
            ### SL3000 ä¼ä¸šçº§å›ºä»¶ï¼ˆProduction_v2ï¼‰
            - **æ„å»º ID**: ${{ github.run_number }}
            - **ä¸‰ä»¶å¥—çŠ¶æ€**: Hash æ ¡éªŒé€šè¿‡ + å®‰å…¨æ³¨å†Œ
            - **å¯å¤ç°æ€§**: feeds.lock å·²å¯ç”¨
            - **ç¼“å­˜çŠ¶æ€**: æ™ºèƒ½ç¼“å­˜å‘½ä¸­
          files: |
            output/*
            collect_logs/*
