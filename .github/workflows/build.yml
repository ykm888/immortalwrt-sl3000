name: build-sl3000-2410

on:
  workflow_dispatch:

env:
  WORKDIR: ${{ github.workspace }}/openwrtsrc
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  SOURCE_REPO: https://github.com/immortalwrt/immortalwrt.git
  SOURCE_BRANCH: openwrt-24.10

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          path: repo

      - name: å®‰è£…æ„å»ºä¾èµ–é¡¹ + ccache
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential flex bison gawk m4 \
            python3 python3-pip python3-setuptools python3-wheel \
            libssl-dev libffi-dev ccache

      - name: ç¼“å­˜ ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: sl3000-2410-ccache-${{ github.sha }}
          restore-keys: sl3000-2410-ccache-

      - name: æ¸…ç†ä¿¡æ¯æµé…ç½®
        run: |
          rm -rf "${{ env.WORKDIR }}"
          mkdir -p "${{ env.WORKDIR }}"

      - name: å…‹éš† OpenWrt æºç 
        run: |
          git clone --depth=1 -b "${{ env.SOURCE_BRANCH }}" \
            "${{ env.SOURCE_REPO }}" "${{ env.WORKDIR }}"

      - name: æ³¨å…¥ä¸‰ä»¶å¥—ï¼ˆDTS / MK / CONFIGï¼‰
        run: |
          cd "$WORKDIR"
          mkdir -p target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek
          cp "$GITHUB_WORKSPACE/repo/target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts" \
             target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek/
          mkdir -p target/linux/mediatek/image
          cp "$GITHUB_WORKSPACE/repo/target/linux/mediatek/image/filogic.mk" \
             target/linux/mediatek/image/
          mkdir -p sl3000/config
          cp "$GITHUB_WORKSPACE/repo/sl3000/config/sl3000.config" \
             sl3000/config/

      - name: ç¡®ä¿ feeds.conf å­˜åœ¨ï¼ˆImmortalWrt å®˜æ–¹ feedï¼‰
        run: |
          cd "$WORKDIR"
          echo "src-git packages https://github.com/immortalwrt/packages.git" > feeds.conf
          echo "src-git luci https://github.com/immortalwrt/luci.git" >> feeds.conf
          echo "src-git routing https://github.com/immortalwrt/routing.git" >> feeds.conf
          echo "src-git telephony https://github.com/immortalwrt/telephony.git" >> feeds.conf

      - name: è¿è¡Œ clean-feeds.shï¼ˆç™½åå•ï¼‰
        working-directory: ${{ env.WORKDIR }}
        run: |
          cp "$GITHUB_WORKSPACE/repo/scripts/clean-feeds.sh" "$WORKDIR/clean-feeds.sh"
          chmod +x "$WORKDIR/clean-feeds.sh"
          ./clean-feeds.sh

      # ğŸ”¥ğŸ”¥ğŸ”¥ å…³é”®ä¿®å¤ï¼šç”Ÿæˆå®Œæ•´ .configï¼Œé¿å… menuconfig
      - name: ç”Ÿæˆå®Œæ•´ defconfigï¼ˆé¿å… menuconfigï¼‰
        working-directory: ${{ env.WORKDIR }}
        run: |
          make defconfig

      - name: å…¨å±€ç¦ç”¨ menuconfig
        working-directory: ${{ env.WORKDIR }}
        run: |
          echo "# CONFIG_DEVEL is not set" >> .config
          echo "# CONFIG_BUILD_MENUCONFIG is not set" >> .config

      - name: ä¸‹è½½æºæ–‡ä»¶ï¼ˆè‡ªæ„ˆï¼‰
        working-directory: ${{ env.WORKDIR }}
        run: |
          make download -j$(nproc) V=s || make download -j1 V=s

      - name: æ„å»ºä¸»æœºå·¥å…·ï¼ˆè‡ªæ„ˆï¼‰
        working-directory: ${{ env.WORKDIR }}
        run: |
          make tools/install -j$(nproc) V=s || make tools/install -j1 V=s

      - name: æ„å»ºå·¥å…·é“¾ï¼ˆè‡ªæ„ˆï¼‰
        working-directory: ${{ env.WORKDIR }}
        run: |
          make toolchain/install -j$(nproc) V=s || make toolchain/install -j1 V=s

      - name: å†æ¬¡æ‰§è¡Œ clean-feeds.shï¼ˆä¸‰ä»¶å¥—ä¸€è‡´æ€§ï¼‰
        working-directory: ${{ env.WORKDIR }}
        run: |
          ./clean-feeds.sh

      - name: è‡ªåŠ¨ä¿®å¤ä¸‰æ®µå¼å‘½å
        working-directory: ${{ env.WORKDIR }}
        run: |
          sed -i 's/DEVICE_DTS := .*/DEVICE_DTS := mt7981b-sl3000-emmc/' \
            target/linux/mediatek/image/filogic.mk

      - name: åº”ç”¨ DTS
        working-directory: ${{ env.WORKDIR }}
        run: |
          cp "$GITHUB_WORKSPACE/repo/target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts" \
             target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek/

      - name: åº”ç”¨ MK
        working-directory: ${{ env.WORKDIR }}
        run: |
          cp "$GITHUB_WORKSPACE/repo/target/linux/mediatek/image/filogic.mk" \
             target/linux/mediatek/image/

      - name: æ„å»ºå†…æ ¸ï¼ˆè‡ªæ„ˆï¼‰
        working-directory: ${{ env.WORKDIR }}
        run: |
          make target/linux/compile -j$(nproc) V=s || make target/linux/compile -j1 V=s

      - name: æ„å»ºè½¯ä»¶åŒ…ï¼ˆè‡ªæ„ˆï¼‰
        working-directory: ${{ env.WORKDIR }}
        run: |
          make package/compile -j$(nproc) V=s || make package/compile -j1 V=s
