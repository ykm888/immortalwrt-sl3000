name: Enterprise_SL3000_MT7981B_Build_v2410

on:
  workflow_dispatch:
  push:
    paths:
      - 'sl3000/**'
      - 'scripts/**'

env:
  SOURCE_REPO: https://github.com/immortalwrt/immortalwrt.git
  SOURCE_BRANCH: openwrt-24.10
  WORK_DIR: /mnt/openwrt
  CCACHE_DIR: /mnt/openwrt/.ccache

jobs:
  Pre-Flight-Check:
    name: ğŸ›¡ï¸ ç¯å¢ƒé¢„æ£€ä¸ç©ºé—´å›æ”¶
    runs-on: ubuntu-22.04
    outputs:
      status: ${{ job.status }}
    steps:
      - name: ä¼˜åŒ– Runner ç£ç›˜ç©ºé—´
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell
          sudo docker image prune -a -f
          sudo mkdir -p ${{ env.WORK_DIR }}
          sudo chown -R $USER:$USER /mnt
          df -h

  Core-Build:
    name: ğŸ—ï¸ æ ¸å¿ƒä½“ç³»æ„å»º
    needs: Pre-Flight-Check
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Install Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache python3 libncurses5-dev gawk gettext libssl-dev
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=5G" >> $GITHUB_ENV

      - name: Restore Caches
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.WORK_DIR }}/.ccache
            ${{ env.WORK_DIR }}/dl
          key: ${{ runner.os }}-build-v2410-${{ github.sha }}
          restore-keys: ${{ runner.os }}-build-v2410-

      - name: Clone & Update Feeds
        run: |
          git clone --depth=1 -b ${{ env.SOURCE_BRANCH }} ${{ env.SOURCE_REPO }} ${{ env.WORK_DIR }}
          cd ${{ env.WORK_DIR }}
          ./scripts/feeds update -a

      - name: ğŸ§© å·¥ç¨‹ä½“ç³»è‡ªæ„ˆæ³¨å†Œ (DTS/MK/Config)
        working-directory: ${{ env.WORK_DIR }}
        run: |
          echo ">>> å¼€å§‹å…¨é“¾è·¯ä¸‰ä»¶å¥—æ£€æµ‹..."
          
          # [è‡ªæ„ˆæŸ¥æ‰¾]
          DTS_FILE=$(find $GITHUB_WORKSPACE/repo -name "mt7981b-sl3000-emmc.dts" | head -n 1)
          MK_PATCH=$(find $GITHUB_WORKSPACE/repo -name "filogic-sl3000.mk" | head -n 1)
          CONF_FILE=$(find $GITHUB_WORKSPACE/repo -name "sl3000.config" | head -n 1)

          # [å‰ç½®æ ¡éªŒ]
          if [[ -z "$DTS_FILE" || -z "$MK_PATCH" || -z "$CONF_FILE" ]]; then
            echo "[ERROR] ä¸‰ä»¶å¥—æ–‡ä»¶ç¼ºå¤±ï¼Œç»ˆæ­¢æ„å»ºï¼"
            exit 1
          fi

          # [ç¡¬ä»¶æè¿°ç¬¦æ³¨å†Œ]
          mkdir -p target/linux/mediatek/dts
          cp -v "$DTS_FILE" target/linux/mediatek/dts/

          # [ç¼–è¯‘è„šæœ¬ MK æ³¨å†Œ]
          MK_TARGET="target/linux/mediatek/image/filogic.mk"
          if ! grep -q "sl_3000-emmc" "$MK_TARGET"; then
            echo ">>> æ³¨å†Œ SL3000 è®¾å¤‡ ID è‡³ MK ç³»ç»Ÿ"
            cat "$MK_PATCH" >> "$MK_TARGET"
          fi

          # [ä¾èµ–è¡¥ç¼´ä¸ Config æ³¨å†Œ]
          ./scripts/feeds install -p packages libcrypt-compat libpam libtirpc libev lm-sensors wsdd2
          cp -v "$CONF_FILE" .config
          
          # [å…ƒæ•°æ®æ³¨å…¥]
          echo "CONFIG_VERSION_NUMBER=\"SL3000-Enterprise-$(date +%Y%m%d)\"" >> .config
          echo "CONFIG_PACKAGE_libcrypt-compat=y" >> .config
          
          make defconfig

      - name: ğŸ“¥ Source Download (Healing)
        working-directory: ${{ env.WORK_DIR }}
        run: |
          make download -j$(nproc) || make download -j1 V=s
          find dl -type f -size 0 -delete

      - name: ğŸš€ Multi-Thread Compilation
        working-directory: ${{ env.WORK_DIR }}
        run: |
          ccache -z
          make -j$(nproc) || make -j1 V=s
          ccache -s

      - name: ğŸ“¦ Archive Artifacts
        run: |
          mkdir -p output
          find ${{ env.WORK_DIR }}/bin/targets/mediatek/filogic/ -name "*sl_3000-emmc*.bin" -exec cp {} output/ \;

      - name: ğŸš€ CD Release
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: Build_${{ github.run_number }}
          name: SL3000_Enterprise_Release_v24.10_${{ github.run_number }}
          body: |
            ### ğŸ—ï¸ æ„å»ºå…ƒæ•°æ®
            - **Status**: Successful
            - **Build Number**: ${{ github.run_number }}
            - **Kernel Version**: Filogic 6.6+
            - **Optimization**: Fully Automated Self-Healing Enabled
          files: output/*.bin
