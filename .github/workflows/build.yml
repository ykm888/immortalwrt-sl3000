name: build-sl3000-openwrt-2410

on:
  workflow_dispatch:   # ‰ªÖÊâãÂä®Ëß¶Âèë

permissions:
  contents: write
  packages: write

jobs:
  build-sl3000-2410:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      # ============================================================
      # üî• Ëá™Âä®ÈÄÄÂá∫‰øùÊä§ÔºöÈò≤Ê≠¢‰øùÂ≠ò workflow Êó∂Ëá™Âä®ÊûÑÂª∫
      # ============================================================
      - name: Skip auto-run when workflow file is modified
        if: github.event_name == 'push' && contains(join(github.event.commits.*.modified), '.github/workflows/')
        run: |
          echo "Workflow file modified. Skipping auto-run."
          exit 0

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Prepare disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          sudo apt-get update
          sudo apt-get remove -y '^aspnetcore-.' '^dotnet-.' '^llvm-.' 'php.' '^mongodb-.' '^mysql-.' '^postgresql-.' '^google-.' '^azure-.*' '^powershell$' || true
          sudo apt-get autoremove -y
          sudo apt-get clean
          sudo rm -rf /usr/share/man /usr/share/doc /usr/share/doc-base

      - name: Prepare /mnt/openwrt
        run: |
          sudo mkdir -p /mnt/openwrt
          sudo chown -R $USER:$USER /mnt
          mkdir -p /mnt/openwrt

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libncurses5-dev zlib1g-dev gawk flex gettext git-core \
            libssl-dev rsync ccache unzip python3 python3-distutils python3-setuptools \
            subversion swig libncursesw5-dev libelf-dev ecj fastjar java-propose-classpath \
            libglib2.0-dev libfuse-dev liblzma-dev pkg-config libusb-1.0-0-dev \
            libudev-dev libpci-dev libreadline-dev libyaml-dev libjson-c-dev \
            bison bc

      - name: Clone ImmortalWrt 24.10
        run: |
          rm -rf /mnt/openwrt
          git clone --depth=1 -b openwrt-24.10 https://github.com/immortalwrt/immortalwrt.git /mnt/openwrt

      - name: Initial feeds update
        working-directory: /mnt/openwrt
        run: ./scripts/feeds update -a

      - name: Refresh feeds
        working-directory: /mnt/openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # ============================================================
      # üî• ÁîüÊàê DTSÔºàÊó† EOFÔºâ
      # ============================================================

      - name: Generate SL3000 DTS
        working-directory: /mnt/openwrt
        run: |
          mkdir -p target/linux/mediatek/dts
          DTS=target/linux/mediatek/dts/mt7981b-sl-3000-emmc.dts
          : > "$DTS"
          echo "// SPDX-License-Identifier: GPL-2.0-or-later OR MIT" >> "$DTS"
          echo "" >> "$DTS"
          echo "/dts-v1/;" >> "$DTS"
          echo "" >> "$DTS"
          echo "#include <dt-bindings/gpio/gpio.h>" >> "$DTS"
          echo "#include <dt-bindings/input/input.h>" >> "$DTS"
          echo "#include <dt-bindings/leds/common.h>" >> "$DTS"
          echo "" >> "$DTS"
          echo "#include \"mt7981.dtsi\"" >> "$DTS"
          echo "" >> "$DTS"
          echo "/ {" >> "$DTS"
          echo "  model = \"SL-3000 eMMC bootstrap versions\";" >> "$DTS"
          echo "  compatible = \"sl,3000-emmc\", \"mediatek,mt7981\";" >> "$DTS"
          echo "" >> "$DTS"
          echo "  aliases {" >> "$DTS"
          echo "    serial0 = &uart0;" >> "$DTS"
          echo "    led-boot = &statusredled;" >> "$DTS"
          echo "    led-failsafe = &statusredled;" >> "$DTS"
          echo "    led-running = &statusgreenled;" >> "$DTS"
          echo "    led-upgrade = &statusblueled;" >> "$DTS"
          echo "  };" >> "$DTS"
          echo "" >> "$DTS"
          echo "  chosen {" >> "$DTS"
          echo "    bootargs = \"root=PARTLABEL=rootfs rootwait\";" >> "$DTS"
          echo "    stdout-path = \"serial0:115200n8\";" >> "$DTS"
          echo "  };" >> "$DTS"
          echo "" >> "$DTS"
          echo "  memory@40000000 {" >> "$DTS"
          echo "    device_type = \"memory\";" >> "$DTS"
          echo "    reg = <0x0 0x40000000 0x0 0x40000000>;" >> "$DTS"
          echo "  };" >> "$DTS"
          echo "};" >> "$DTS"

      # ============================================================
      # üî• ÁîüÊàê MKÔºàÊó† EOFÔºâ
      # ============================================================

      - name: Generate SL3000 MK
        working-directory: /mnt/openwrt
        run: |
          MK=target/linux/mediatek/image/filogic.mk

          sed -i '/Device\/sl_3000-emmc/,/endef/d' "$MK"
          sed -i '/TARGET_DEVICES += sl3000-emmc/d' "$MK"

          echo "" >> "$MK"
          echo "define Device/sl_3000-emmc" >> "$MK"
          echo "  DEVICE_VENDOR := SL" >> "$MK"
          echo "  DEVICE_MODEL := 3000 eMMC" >> "$MK"
          echo "  DEVICE_DTS := mt7981b-sl-3000-emmc" >> "$MK"
          echo "  DEVICE_DTS_DIR := ../dts" >> "$MK"
          echo "  DEVICE_PACKAGES := kmod-mt7915e kmod-mt7981-firmware mt7981-wo-firmware automount coremark blkid blockdev fdisk f2fsck mkf2fs kmod-mmc" >> "$MK"
          echo "  KERNEL := kernel-bin | lzma | fit lzma \$\$(KDIR)/image-\$\$(firstword \$\$(DEVICE_DTS)).dtb" >> "$MK"
          echo "  KERNEL_INITRAMFS := kernel-bin | lzma | fit lzma \$\$(KDIR)/image-\$\$(firstword \$\$(DEVICE_DTS)).dtb with-initrd | pad-to 64k" >> "$MK"
          echo "  IMAGE/sysupgrade.bin := sysupgrade-tar | append-metadata" >> "$MK"
          echo "endef" >> "$MK"
          echo "" >> "$MK"
          echo "TARGET_DEVICES += sl3000-emmc" >> "$MK"

      # ============================================================
      # üî• defconfig ÂøÖÈ°ªÂú® CONFIG ‰πãÂâç
      # ============================================================

      - name: Base defconfig
        working-directory: /mnt/openwrt
        run: make defconfig

      # ============================================================
      # üî• ÁîüÊàê CONFIGÔºàÂøÖÈ°ªÂú® defconfig ‰πãÂêéÔºâ
      # ============================================================

      - name: Generate SL3000 CONFIG
        working-directory: /mnt/openwrt
        run: |
          CFG=/mnt/openwrt/.config

          sed -i '/CONFIG_TARGET_DEVICE_mediatek_mt7981_DEVICE_sl_3000-emmc/d' "$CFG"
          echo "CONFIG_TARGET_DEVICE_mediatek_mt7981_DEVICE_sl_3000-emmc=y" >> "$CFG"

          for k in \
            CONFIG_PACKAGE_kmod-mt7915e \
            CONFIG_PACKAGE_kmod-mt7981-firmware \
            CONFIG_PACKAGE_mt7981-wo-firmware \
            CONFIG_PACKAGE_kmod-mmc \
            CONFIG_PACKAGE_luci \
            CONFIG_PACKAGE_luci-base \
            CONFIG_PACKAGE_luci-i18n-base-zh-cn \
          ; do
            sed -i "/$k/d" "$CFG"
            echo "$k=y" >> "$CFG"
          done

      # ============================================================
      # üî• Ê†°È™å‰∏â‰ª∂Â•óÔºàÂøÖÈ°ªÂú® /mnt/openwrtÔºâ
      # ============================================================

      - name: Validate SL3000 three-piece set
        working-directory: /mnt/openwrt
        run: |
          DTS=target/linux/mediatek/dts/mt7981b-sl-3000-emmc.dts
          MK=target/linux/mediatek/image/filogic.mk
          CFG=/mnt/openwrt/.config

          echo "=== Check DTS ==="
          [ -s "$DTS" ] || { echo "[FATAL] DTS missing"; exit 1; }

          echo "=== Check MK ==="
          grep -q "define Device/sl_3000-emmc" "$MK" || { echo "[FATAL] MK missing Device/sl_3000-emmc"; exit 1; }
          grep -q "TARGET_DEVICES += sl3000-emmc" "$MK" || { echo "[FATAL] MK missing TARGET_DEVICES"; exit 1; }

          echo "=== Check CONFIG ==="
          grep -q '^CONFIG_TARGET_DEVICE_mediatek_mt7981_DEVICE_sl_3000-emmc=y' "$CFG" \
            || { echo "[FATAL] CONFIG missing device enable"; exit 1; }

      # ============================================================
      # üî• ÊûÑÂª∫ÈìæÔºà‰øùÊåÅ‰∏çÂèòÔºâ
      # ============================================================

      - name: Download sources
        working-directory: /mnt/openwrt
        run: make download -j8 || { rm -rf dl/*; make download -j4; }

      - name: Build toolchain
        working-directory: /mnt/openwrt
        run: make toolchain/install -j"$(nproc)"

      - name: Build kernel
        working-directory: /mnt/openwrt
        run: make target/linux/compile -j"$(nproc)" V=s

      - name: Build packages
        working-directory: /mnt/openwrt
        run: make package/compile -j"$(nproc)" V=s

      - name: Build images
        working-directory: /mnt/openwrt
        run: make target/image/compile -j"$(nproc)" V=s

      - name: Full world build
        working-directory: /mnt/openwrt
        run: make -j"$(nproc)" V=s

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-2410-firmware
          path: /mnt/openwrt/bin/targets/mediatek/mt7981/*
