name: Enterprise_SL3000_MT7981B_Production

on:
  workflow_dispatch:

env:
  # ä¿®å¤ WORK_DIR ç¨³å®šæ€§ï¼šä½¿ç”¨å½“å‰å·¥ä½œåŒº
  WORK_DIR: openwrt_src
  CCACHE_DIR: ${{ github.workspace }}/.ccache

jobs:
  Build:
    runs-on: ubuntu-22.04
    steps:
      - name: ğŸ›¡ï¸ æ£€å‡ºå·¥ç¨‹ä»“åº“
        uses: actions/checkout@v4
        with:
          path: repo

      - name: ğŸ§¹ ç£ç›˜ç©ºé—´æ·±åº¦ä¼˜åŒ–
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune -a -f
          mkdir -p ${{ env.WORK_DIR }}
          df -h

      - name: ğŸ› ï¸ å‡†å¤‡æ„å»ºç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache python3 libncurses5-dev gawk gettext libssl-dev
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=5G" >> $GITHUB_ENV

      - name: ğŸ’¾ æ™ºèƒ½ç¼“å­˜ (Key ä¿®å¤)
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CCACHE_DIR }}
            ${{ env.WORK_DIR }}/dl
          # åŸºäºè„šæœ¬ Hash å’Œ Configï¼Œç¡®ä¿ç¼“å­˜åªåœ¨ä¾èµ–å˜åŠ¨æ—¶å¤±æ•ˆ
          key: ${{ runner.os }}-openwrt-v1-${{ hashFiles('repo/**/clean-feeds.sh', 'repo/**/*.config') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-v1-

      - name: ğŸ“¥ å…‹éš†æºç  (24.10)
        run: git clone --depth=1 -b openwrt-24.10 https://github.com/immortalwrt/immortalwrt.git ${{ env.WORK_DIR }}

      - name: ğŸš€ è¿è¡Œå…¨é“¾è·¯è‡ªæ„ˆè„šæœ¬
        working-directory: ${{ env.WORK_DIR }}
        run: |
          # åŠ¨æ€å¯»æ‰¾å¹¶æ‰§è¡Œè„šæœ¬
          SCRIPT=$(find $GITHUB_WORKSPACE/repo -name "clean-feeds.sh" | head -n 1)
          chmod +x "$SCRIPT"
          bash "$SCRIPT"

      - name: ğŸ§© æ³¨å…¥é…ç½®ä¸ç¯å¢ƒè‡ªæ„ˆ
        working-directory: ${{ env.WORK_DIR }}
        run: |
          CONF=$(find $GITHUB_WORKSPACE/repo -name "sl3000.config" | head -n 1)
          [ -f "$CONF" ] && cp "$CONF" .config
          
          # å¼ºåˆ¶é”å®š 24.10 å…¼å®¹é¡¹
          echo "CONFIG_PACKAGE_libcrypt-compat=y" >> .config
          make defconfig

      - name: ğŸ“¥ ä¸‹è½½æºç  (å¤±è´¥é™çº§è‡ªæ„ˆ)
        working-directory: ${{ env.WORK_DIR }}
        run: |
          make download -j$(nproc) || (make download -j1 V=s && exit 1)

      - name: ğŸš€ æ ¸å¿ƒç¼–è¯‘ (è‡ªæ„ˆä½“ç³»)
        working-directory: ${{ env.WORK_DIR }}
        run: |
          ccache -z
          make -j$(nproc) || make -j1 V=s
          ccache -s

      - name: ğŸ“Š æ”¶é›†å…ƒæ•°æ®ä¸æ—¥å¿—
        if: always()
        run: |
          mkdir -p output/logs
          cp ${{ env.WORK_DIR }}/.config output/config.buildinfo || true
          find ${{ env.WORK_DIR }}/bin/targets/mediatek/filogic/ -name "*.bin" -exec cp {} output/ \;
          find ${{ env.WORK_DIR }}/bin/targets/mediatek/filogic/ -name "*.manifest" -exec cp {} output/ \;

      - name: ğŸ“¦ è‡ªåŠ¨åŒ–å›ºä»¶å‘å¸ƒ
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: SL3000_Release_${{ github.run_number }}
          files: |
            output/*.bin
            output/*.manifest
            output/config.buildinfo
