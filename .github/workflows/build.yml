name: Build ImmortalWrt 24.10 (SL3000 eMMC Flagship)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1. æ£€å‡ºä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. ä¼˜åŒ–ç£ç›˜ç©ºé—´
      - name: Optimize disk space
        run: |
          sudo apt-get remove -y --purge azure-cli google-cloud-sdk dotnet* powershell mono* mysql* php* android* || true
          sudo apt-get autoremove -y
          sudo apt-get clean

      # 3. å®‰è£…ä¾èµ–
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git-core libncurses5-dev \
            zlib1g-dev gawk flex gettext wget unzip python3 python3-distutils \
            file libssl-dev rsync ccache

      # 4. ç¼“å­˜ dl å’Œ ccache
      - name: Cache downloads and ccache
        uses: actions/cache@v4
        with:
          path: |
            openwrt/dl
            openwrt/.ccache
          key: ${{ runner.os }}-immortalwrt-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-immortalwrt-

      # 5. æ‹‰å–æºç ï¼ˆä¿®å¤ï¼šé¿å… clone è‡ªå·±ä»“åº“ï¼‰
      - name: Clone ImmortalWrt source
        run: |
          git clone --depth=1 -b openwrt-24.10 https://github.com/immortalwrt/immortalwrt.git openwrt
          echo "âœ… å·²æ‹‰å– ImmortalWrt openwrt-24.10 æºç "

      # 6. å¤åˆ¶æ ¹ç›®å½• .config åˆ°æºç ç›®å½•
      - name: Use root .config
        run: |
          cp .config openwrt/.config
          echo "âœ… å·²ä½¿ç”¨æ ¹ç›®å½• .config"

      # 7. ä¸‰ä»¶å¥—è‡ªåŠ¨æ£€æµ‹ï¼ˆå¢å¼ºç‰ˆ + é›†æˆè„šæœ¬ï¼‰
      - name: Verify DTS/mk/config alignment (Enhanced)
        run: |
          cd openwrt

          DTS="target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts"
          MK="target/linux/mediatek/image/filogic.mk"
          CONF=".config"
          DEV="sl3000-emmc"

          echo "=== ğŸ” ä¸‰ä»¶å¥—å®Œæ•´æ€§æ£€æŸ¥å¼€å§‹ ==="

          # 1. æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥
          for f in "$DTS" "$MK" "$CONF"; do
            if [ ! -f "$f" ]; then
              echo "âŒ ç¼ºå°‘å…³é”®æ–‡ä»¶: $f"
              exit 1
            fi
          done
          echo "âœ” æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥é€šè¿‡"

          # 2. DTS è®¾å¤‡åæ£€æŸ¥
          if ! grep -q "$DEV" "$DTS"; then
            echo "âŒ DTS æœªåŒ…å«è®¾å¤‡å $DEV"
            exit 1
          fi

          # 3. mk è®¾å¤‡æ®µæ£€æŸ¥
          if ! grep -q "Device/$DEV" "$MK"; then
            echo "âŒ mk æœªå®šä¹‰ Device/$DEV"
            exit 1
          fi
          if ! grep -q "TARGET_DEVICES += $DEV" "$MK"; then
            echo "âŒ mk æœªåŠ å…¥ TARGET_DEVICES += $DEV"
            exit 1
          fi

          # 4. config å¯ç”¨è®¾å¤‡æ£€æŸ¥
          if ! grep -q "CONFIG_TARGET_DEVICE_mediatek_filogic_DEVICE_${DEV}=y" "$CONF"; then
            echo "âŒ config æœªå¯ç”¨è®¾å¤‡ $DEV"
            exit 1
          fi

          echo "âœ” DTS/mk/config è®¾å¤‡ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡"

          # 5. éšè—å­—ç¬¦æ£€æŸ¥
          if grep -q $'\xEF\xBB\xBF' "$DTS" "$MK" "$CONF"; then
            echo "âŒ æ£€æµ‹åˆ° BOMï¼Œè¯·æ¸…ç†åå†æäº¤"
            exit 1
          fi
          if grep -q $'\r' "$DTS" "$MK" "$CONF"; then
            echo "âŒ æ£€æµ‹åˆ° CRLFï¼Œè¯·æ¸…ç†åå†æäº¤"
            exit 1
          fi
          if grep -P -q "[\x{200B}\x{200C}\x{200D}]" "$DTS" "$MK" "$CONF"; then
            echo "âŒ æ£€æµ‹åˆ°é›¶å®½å­—ç¬¦ï¼Œè¯·æ¸…ç†åå†æäº¤"
            exit 1
          fi

          echo "âœ” éšè—å­—ç¬¦æ£€æŸ¥é€šè¿‡"

          # 6. kernel ç‰ˆæœ¬ä¸€è‡´æ€§
          if grep -q "CONFIG_LINUX_6_12=y" "$CONF"; then
            echo "âš ï¸ æ£€æµ‹åˆ° CONFIG_LINUX_6_12=yï¼Œåº”ä¸º 6.6ï¼Œè‡ªåŠ¨ä¿®å¤"
            sed -i 's/CONFIG_LINUX_6_12=y/CONFIG_LINUX_6_6=y/' "$CONF"
          fi

          echo "=== âœ… ä¸‰ä»¶å¥—å¢å¼ºæ£€æµ‹å…¨éƒ¨é€šè¿‡ ==="

      # 8. æ›´æ–° feeds
      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a || true
          ./scripts/feeds install -a

      # 9. åº”ç”¨è·¯ç”±å™¨ç›¸å…³è¡¥ä¸
      - name: Apply router patches
        run: |
          cd openwrt
          if [ -d patches ]; then
            for p in patches/*; do
              if [[ "$p" == *"mediatek"* || "$p" == *"network"* ]]; then
                patch -p1 < "$p"
              else
                echo "è·³è¿‡éè·¯ç”±å™¨è¡¥ä¸: $p"
              fi
            done
          else
            echo "âš ï¸ æ—  patches ç›®å½•ï¼Œè·³è¿‡è¡¥ä¸åº”ç”¨"
          fi

      # 10. æ„å»ºå›ºä»¶
      - name: Build firmware
        run: |
          cd openwrt
          make defconfig
          make -j$(nproc) V=s | tee build.log
          echo "âœ… æ„å»ºå®Œæˆ"

      # 11. ä¸Šä¼ æ„å»ºæ—¥å¿—
      - name: Upload build log
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: openwrt/build.log

      # 12. ä¿å­˜æ„å»ºäº§ç‰©
      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-sl3000-emmc
          path: openwrt/bin/targets/mediatek/filogic/

      # 13. è‡ªåŠ¨å‘å¸ƒå›ºä»¶
      - name: Release firmware
        uses: softprops/action-gh-release@v1
        with:
          tag_name: sl3000-emmc-${{ github.run_number }}
          name: "SL3000 eMMC Firmware Build #${{ github.run_number }}"
          body: |
            è‡ªåŠ¨æ„å»ºçš„ SL3000 eMMC å›ºä»¶ (ImmortalWrt 24.10)
            - ä¸‰ä»¶å¥—æ£€æµ‹ä¸ä¿®å¤ï¼ˆå¢å¼ºç‰ˆï¼‰ âœ…
            - ä¼˜åŒ–ç£ç›˜ç©ºé—´ âœ…
            - è·¯ç”±å™¨ç›¸å…³è¡¥ä¸è¿‡æ»¤æœºåˆ¶ âœ…
            - ç¼“å­˜æœºåˆ¶ï¼ˆdl + ccacheï¼‰âœ…
          files: |
            openwrt/bin/targets/mediatek/filogic/*
