name: build-sl3000-2410

on:
  workflow_dispatch:

env:
  WORKDIR: ${{ github.workspace }}/openwrt-src
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  SOURCE_REPO: https://github.com/immortalwrt/immortalwrt.git
  SOURCE_BRANCH: openwrt-24.10

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          path: repo

      - name: 安装构建依赖项 + ccache
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential flex bison gawk m4 \
            python3 python3-pip python3-setuptools python3-wheel \
            libssl-dev libffi-dev ccache

      - name: 缓存 ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: sl3000-2410-ccache-${{ github.sha }}
          restore-keys: sl3000-2410-ccache-

      - name: 清理工作目录
        run: |
          rm -rf "${{ env.WORKDIR }}"
          mkdir -p "${{ env.WORKDIR }}"

      - name: 克隆 ImmortalWrt 源码
        run: |
          git clone --depth=1 -b "${{ env.SOURCE_BRANCH }}" \
            "${{ env.SOURCE_REPO }}" "${{ env.WORKDIR }}"

      - name: 注入三件套（DTS / MK / CONFIG）
        run: |
          cd "$WORKDIR"

          mkdir -p target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek
          cp "$GITHUB_WORKSPACE/repo/target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts" \
             target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek/

          mkdir -p target/linux/mediatek/image
          cp "$GITHUB_WORKSPACE/repo/target/linux/mediatek/image/filogic.mk" \
             target/linux/mediatek/image/

          mkdir -p sl3000/config
          cp "$GITHUB_WORKSPACE/repo/sl3000/config/sl3000.config" \
             sl3000/config/

      - name: feeds.conf 兜底（无 EOF）
        working-directory: ${{ env.WORKDIR }}
        run: |
          if [ -f feeds.conf.default ] && [ ! -f feeds.conf ]; then
            cp feeds.conf.default feeds.conf
          fi

          if [ ! -f feeds.conf ] && [ ! -f feeds.conf.default ]; then
            echo "src-git packages https://github.com/immortalwrt/packages.git" > feeds.conf
            echo "src-git luci https://github.com/immortalwrt/luci.git" >> feeds.conf
            echo "src-git routing https://github.com/immortalwrt/routing.git" >> feeds.conf
          fi

      - name: 运行 clean-feeds.sh（白名单 + 显示 12 道检测）
        working-directory: ${{ env.WORKDIR }}
        run: |
          echo "================ CLEAN-FEEDS START ================"
          cp "$GITHUB_WORKSPACE/repo/scripts/clean-feeds.sh" clean-feeds.sh
          chmod +x clean-feeds.sh
          set -x
          ./clean-feeds.sh
          set +x
          echo "================ CLEAN-FEEDS END =================="

      - name: 生成基础 defconfig（避免 menuconfig）
        working-directory: ${{ env.WORKDIR }}
        run: |
          make defconfig

      - name: 叠加 sl3000.config（无 EOF）
        working-directory: ${{ env.WORKDIR }}
        run: |
          cat sl3000/config/sl3000.config >> .config
          make defconfig

      - name: 全局禁用 menuconfig
        working-directory: ${{ env.WORKDIR }}
        run: |
          echo "# CONFIG_DEVEL is not set" >> .config
          echo "# CONFIG_BUILD_MENUCONFIG is not set" >> .config

      - name: 下载源文件（自愈）
        working-directory: ${{ env.WORKDIR }}
        run: |
          make download -j$(nproc) V=s || make download -j1 V=s

      - name: 构建主机工具（自愈）
        working-directory: ${{ env.WORKDIR }}
        run: |
          make tools/install -j$(nproc) V=s || make tools/install -j1 V=s

      - name: 构建工具链（自愈）
        working-directory: ${{ env.WORKDIR }}
        run: |
          make toolchain/install -j$(nproc) V=s || make toolchain/install -j1 V=s

      - name: 再次执行 clean-feeds.sh（三件套一致性）
        working-directory: ${{ env.WORKDIR }}
        run: |
          ./clean-feeds.sh

      - name: 自动修复三段式命名
        working-directory: ${{ env.WORKDIR }}
        run: |
          sed -i 's/DEVICE_DTS := .*/DEVICE_DTS := mt7981b-sl3000-emmc/' \
            target/linux/mediatek/image/filogic.mk

      - name: 应用 DTS（最终覆盖）
        working-directory: ${{ env.WORKDIR }}
        run: |
          cp "$GITHUB_WORKSPACE/repo/target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts" \
             target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek/

      - name: 应用 MK（最终覆盖）
        working-directory: ${{ env.WORKDIR }}
        run: |
          cp "$GITHUB_WORKSPACE/repo/target/linux/mediatek/image/filogic.mk" \
             target/linux/mediatek/image/

      - name: 构建内核（自愈）
        working-directory: ${{ env.WORKDIR }}
        run: |
          make target/linux/compile -j$(nproc) V=s || make target/linux/compile -j1 V=s

      - name: 构建软件包（自愈）
        working-directory: ${{ env.WORKDIR }}
        run: |
          make package/compile -j$(nproc) V=s || make package/compile -j1 V=s

      - name: 自动发布固件（无 EOF）
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: sl3000-emmc-openwrt-24.10-${{ github.run_number }}-${{ github.run_id }}
          name: SL3000 eMMC OpenWrt 24.10 #${{ github.run_number }}
          body: |
            Auto Release  
            Target: SL3000 eMMC  
            Build: ${{ github.run_number }}  
            Run ID: ${{ github.run_id }}

          files: |
            ${{ env.WORKDIR }}/bin/targets/mediatek/filogic/*
