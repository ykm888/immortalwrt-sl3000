name: build-sl3000-2410-final

on:
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          path: repo

      - name: 磁盘环境初始化
        run: |
          sudo mkdir -p /mnt/openwrt
          sudo chown -R $USER:$USER /mnt
          rm -rf /mnt/openwrt/* || true

      - name: 安装构建依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache python3 libncurses5-dev gawk gettext libssl-dev
          echo "CCACHE_DIR=/mnt/openwrt/.ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=2G" >> $GITHUB_ENV

      - name: 缓存 ccache
        uses: actions/cache@v4
        with:
          path: /mnt/openwrt/.ccache
          key: ${{ runner.os }}-2410-ccache-${{ github.sha }}
          restore-keys: ${{ runner.os }}-2410-ccache-

      - name: 克隆源码 (ImmortalWrt 24.10)
        run: git clone --depth=1 -b openwrt-24.10 https://github.com/immortalwrt/immortalwrt.git /mnt/openwrt

      - name: 更新 Feeds 索引
        working-directory: /mnt/openwrt
        run: |
          rm -f feeds.conf feeds.conf.default
          echo 'src-git packages https://github.com/openwrt/packages.git' > feeds.conf.default
          echo 'src-git luci https://github.com/openwrt/luci.git' >> feeds.conf.default
          echo 'src-git helloworld https://github.com/fw876/helloworld.git' >> feeds.conf.default
          echo 'src-git small https://github.com/kenzok8/small.git' >> feeds.conf.default
          ./scripts/feeds update -a

      - name: 工程体系自愈逻辑 (清理与核心依赖补全)
        working-directory: /mnt/openwrt
        run: |
          # 1. 剔除导致冲突的旧包
          CONFLICTS="package/system/refpolicy package/system/selinux-policy package/utils/policycoreutils package/utils/pcat-manager package/network/services/lldpd package/boot/kexec-tools package/emortal/default-settings package/libs/libpam package/libs/libtirpc package/libs/libnsl package/libs/xz"
          for p in $CONFLICTS; do rm -rf $p; done
          
          # 2. 补齐 24.10 缺失的关键底层库 (修复 libcrypt-compat 等 WARNING)
          ./scripts/feeds install -p packages libcrypt-compat libpam libtirpc libev libnsl xz lm-sensors wsdd2 attr libsasl2 libusb-compat libcurl libexpat
          ./scripts/feeds install -p luci luci-base luci-compat luci-lua-runtime luci-lib-ip luci-lib-jsonc luci-theme-bootstrap luci-app-samba4

      - name: 应用 SL3000 三件套 (自动检测修复注册)
        working-directory: /mnt/openwrt
        run: |
          # [1] 动态查找文件路径
          DTS_FILE=$(find $GITHUB_WORKSPACE/repo -name "mt7981b-sl3000-emmc.dts" | head -n 1)
          MK_PATCH=$(find $GITHUB_WORKSPACE/repo -name "filogic-sl3000.mk" | head -n 1)
          CONF_FILE=$(find $GITHUB_WORKSPACE/repo -name "sl3000.config" | head -n 1)

          # [2] 注册 DTS (硬件定义)
          if [ -f "$DTS_FILE" ]; then
            mkdir -p target/linux/mediatek/dts
            cp -v "$DTS_FILE" target/linux/mediatek/dts/
          fi

          # [3] 注册 MK (编译脚本自愈)
          MK_TARGET="target/linux/mediatek/image/filogic.mk"
          if [ -f "$MK_PATCH" ]; then
            grep -q "sl_3000-emmc" "$MK_TARGET" || cat "$MK_PATCH" >> "$MK_TARGET"
          fi

          # [4] 注册 Config (配置环境同步)
          if [ -f "$CONF_FILE" ]; then
            cp -v "$CONF_FILE" .config
            # 强行补充缺失的 24.10 兼容项
            echo "CONFIG_PACKAGE_libcrypt-compat=y" >> .config
          fi

          # [5] 执行注册生效
          make defconfig

      - name: 下载源代码 (自愈体系)
        working-directory: /mnt/openwrt
        run: |
          make download -j$(nproc) || make download -j1 V=s
          find dl -type f -size 0 -delete

      - name: 完整编译 (自愈体系)
        working-directory: /mnt/openwrt
        run: |
          make -j$(nproc) || make -j1 V=s

      - name: 收集固件
        run: |
          mkdir -p firmware_export
          find /mnt/openwrt/bin/targets/mediatek/filogic/ -name "*.bin" -exec cp {} firmware_export/ \;

      - name: 自动发布 (Auto Release)
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: sl3000-v24.10-${{ github.run_number }}
          files: firmware_export/*.bin
          body: |
            SL3000 eMMC OpenWrt 24.10
            - 自动修复 libcrypt-compat 依赖断链
            - 自动注册三件套 (DTS/MK/Config)
