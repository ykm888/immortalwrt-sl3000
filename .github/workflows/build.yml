name: Build ImmortalWrt SL3000 eMMC (Auto Three-Piece)

on:
  workflow_dispatch:

# å…¨å±€æƒé™ï¼šæ»¡è¶³ä»£ç æ¨é€ã€Releaseå‘å¸ƒã€Artifactä¸Šä¼ ã€ä»“åº“æ‹‰å–
permissions:
  contents: write
  actions: read
  packages: write

jobs:
  build-sl3000-firmware:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout local repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: repo

      - name: Optimize disk space (Ubuntu 22.04 Runner)
        run: |
          sudo apt-get remove -y --purge azure-cli google-cloud-sdk dotnet powershell mono mysql-server php* android* snapd || true
          sudo apt-get autoremove -y --purge
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/* /usr/share/doc /usr/share/man
          sudo fallocate -l 10G /swapfile && sudo mkswap /swapfile && sudo swapon /swapfile
          free -h && df -h

      - name: Install build dependencies (é€‚é…ImmortalWrt 24.10/Linux 6.6)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential git-core libncurses5-dev \
            zlib1g-dev gawk flex gettext wget unzip python3 python3-distutils \
            file libssl-dev rsync ccache device-tree-compiler subversion libelf-dev \
            bc bison patch gcc-multilib g++-multilib swig libudev-dev libusb-1.0-0-dev

      - name: Clone your ImmortalWrt source (ç²¾å‡†å¯¹é½ ykm888/immortalwrt-sl3000)
        run: |
          sudo rm -rf openwrt || true
          git clone --depth=1 -b main https://github.com/ykm888/immortalwrt-sl3000.git openwrt
          cd openwrt
          git submodule update --init --recursive || true
          echo "âœ… ä»“åº“æ‹‰å–å®Œæˆï¼šykm888/immortalwrt-sl3000 (main)"

      - name: Cache downloads & ccache (cloneåæ‰§è¡Œï¼Œç¼“å­˜100%ç”Ÿæ•ˆ)
        uses: actions/cache@v4
        with:
          path: |
            openwrt/dl
            openwrt/.ccache
          key: ${{ runner.os }}-sl3000-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-sl3000-

      - name: Copy SL3000 tools & add execute permission
        run: |
          cp -r repo/sl3000-tools openwrt/
          chmod +x openwrt/sl3000-tools/*.sh
          ls -l openwrt/sl3000-tools/
          echo "âœ… å·¥å…·å¤åˆ¶å®Œæˆï¼Œæ‰€æœ‰è„šæœ¬å·²æˆæƒæ‰§è¡Œ"

      # ===== è°ƒæ•´é¡ºåºï¼šFeedsæ“ä½œç§»åˆ°æ­¤å¤„ï¼Œå…ˆè£…ä¾èµ–å†ç”Ÿæˆé…ç½® =====
      - name: Update & install ImmortalWrt feeds (å®¹é”™+å®Œæ•´å®‰è£…)
        working-directory: openwrt
        run: |
          ./scripts/feeds update -a --force || true
          # å¼ºåˆ¶å®‰è£…luciæ ¸å¿ƒfeedsï¼Œè§£å†³luciä¾èµ–ç¼ºå¤±
          ./scripts/feeds install -a -f luci luci-base luci-i18n-base-zh-cn || true
          ./scripts/feeds clean || true
          echo "âœ… Feedsæ›´æ–°&å®‰è£…å®Œæˆï¼Œå·²å¼ºåˆ¶å®‰è£…Luciæ ¸å¿ƒåŒ…"

      - name: Generate SL3000 Three-Piece Set (è¿è¡Œä½ çš„ç”Ÿæˆè„šæœ¬)
        working-directory: openwrt
        run: |
          ./sl3000-tools/generate-three-piece.sh
          # éªŒè¯é…ç½®ç”Ÿæˆç»“æœï¼Œæ£€æŸ¥å…³é”®åŒ…æ˜¯å¦å·²æ·»åŠ 
          if grep -q "CONFIG_PACKAGE_luci-base=y" .config; then
            echo "âœ… Luciæ ¸å¿ƒåŒ…é…ç½®å·²ç”Ÿæ•ˆ"
          else
            echo "âŒ Luciæ ¸å¿ƒåŒ…é…ç½®æœªç”Ÿæˆ"
            cat .config && exit 1
          fi
          if [ -f "target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts" ]; then
            echo "âœ… DTSç”ŸæˆæˆåŠŸï¼Œæ–‡ä»¶å­˜åœ¨"
          else
            echo "âŒ DTSç”Ÿæˆå¤±è´¥ï¼Œæ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

      # ===== é‡å†™è¯¥æ­¥éª¤ï¼šå¼ºåˆ¶é”å®šè‡ªå®šä¹‰é…ç½®ï¼Œé¿å…è¢«è¦†ç›– =====
      - name: Normalize config & init CCACHE (å¼ºåˆ¶é”å®šè‡ªå®šä¹‰é…ç½®)
        working-directory: openwrt
        run: |
          # 1. æå‰åˆ›å»º.ccacheç›®å½•å¹¶èµ‹æƒ
          mkdir -p .ccache
          chmod 777 .ccache
          echo 'max_size = 10G' > .ccache/ccache.conf
          echo 'compression = true' >> .ccache/ccache.conf
          echo 'cache_dir = .ccache' >> .ccache/ccache.conf
          ccache -C && ccache -z && ccache -s
          # 2. å¼ºåˆ¶å°†è‡ªå®šä¹‰.configè®¾ä¸ºé»˜è®¤é…ç½®ï¼Œé¿å…è¢«OpenWrtè¦†ç›–
          cp .config defconfig
          mv defconfig configs/
          # 3. æ‰§è¡Œmake defconfigï¼ŒæŒ‡å®šåŠ è½½è‡ªå®šä¹‰çš„defconfig
          make defconfig V=s CONFIG_DEFCONFIG=configs/defconfig
          # 4. éªŒè¯é…ç½®æ˜¯å¦ä»ç”Ÿæ•ˆ
          if grep -q "CONFIG_PACKAGE_luci-base=y" .config; then
            echo "âœ… è‡ªå®šä¹‰é…ç½®é”å®šæˆåŠŸï¼Œæœªè¢«è¦†ç›–"
          else
            echo "âŒ è‡ªå®šä¹‰é…ç½®è¢«è¦†ç›–ï¼Œæ„å»ºç»ˆæ­¢"
            cat .config && exit 1
          fi
          echo "âœ… è‡ªå®šä¹‰é…ç½®å·²æ ‡å‡†åŒ–ï¼ŒCCACHEåˆå§‹åŒ–å®Œæˆ"

      - name: Build toolchain (ä¸è‡ªå®šä¹‰é…ç½®åŒ¹é…ï¼Œè§£è€¦ç¼–è¯‘)
        working-directory: openwrt
        run: |
          make toolchain/install -j$(nproc) V=s CCACHE=1 | tee toolchain-build.log
          ccache -s
          echo "âœ… å·¥å…·é“¾æ„å»ºå®Œæˆ"

      - name: Build SL3000 eMMC firmware (é˜²OOM+å®Œæ•´æ—¥å¿—)
        working-directory: openwrt
        run: |
          make -j$(nproc) V=s CCACHE=1 CONFIG_DEBUG_SECTION_MISMATCH=y | tee firmware-build.log
          ccache -s
          echo "âœ… å›ºä»¶ç¼–è¯‘å®Œæˆ"

      - name: Upload all build logs (æ–¹ä¾¿äº‘æ„å»ºæ’é”™)
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-build-logs
          path: |
            openwrt/toolchain-build.log
            openwrt/firmware-build.log
            openwrt/sl3000-tools/sl3000-three-piece-generate.log
          retention-days: 7

      - name: Upload firmware artifacts (å®Œæ•´äº§ç‰©)
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-sl3000-emmc-firmware
          path: openwrt/bin/targets/mediatek/filogic/
          retention-days: 30

      - name: Auto Release firmware (ä»…æ„å»ºæˆåŠŸæ—¶å‘å¸ƒ)
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tagname: sl3000-emmc-build-${{ github.run_number }}-${{ github.run_id }}
          name: SL3000 eMMC Firmware #${{ github.run_number }}
          body: |
            ğŸš€ è‡ªåŠ¨æ„å»ºï¼šå¸ç»œSL3000 (MT7981B eMMC)
            ğŸ“Œ æºç ä»“åº“ï¼šykm888/immortalwrt-sl3000 (main)
            ğŸ›  è‡ªåŠ¨ç”Ÿæˆä¸‰ä»¶å¥—(DTS/MK/CONFIG)ï¼Œå·¥ç¨‹çº§æ——èˆ°ç‰ˆé…ç½®
            ğŸ“¦ å†…ç½®ï¼šDocker/Passwall2/SSR Plus+/eMMCæ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
            ğŸ“ æ„å»ºæ—¥å¿—ï¼šæŸ¥çœ‹Artifacts â†’ sl3000-build-logs
            âš™ï¸ å†…æ ¸ç‰ˆæœ¬ï¼šLinux 6.6 (ImmortalWrt 24.10)
            âœ… ä¿®å¤ï¼šé…ç½®è¢«è¦†ç›–/ä¾èµ–è­¦å‘Š/CCACHEç¼ºå¤±/DTSè¯­æ³•/ä¹±ç 
          files: openwrt/bin/targets/mediatek/filogic/*
          prerelease: true
          draft: false
