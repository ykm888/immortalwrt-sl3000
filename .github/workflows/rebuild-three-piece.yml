name: SL3000 ImmortalWrt 24.10 Build
on:
  push:
    branches: [ main ]
    paths:
      - 'gen-sl3000-three-piece.sh'
      - '.github/workflows/sl3000-build.yml'
  workflow_dispatch: # 手动触发

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      # 关键：指定ImmortalWrt源码根目录（工作流中克隆后的路径）
      IWRT_ROOT: /home/runner/work/immortalwrt-sl3000/immortalwrt-sl3000
      SCRIPT_NAME: gen-sl3000-three-piece.sh

    steps:
      - name: 1. 拉取仓库源码（完整克隆，非浅克隆）
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 关键：完整拉取，避免filogic目录缺失
          path: .

      - name: 2. 安装基础依赖（Actions环境补全）
        run: |
          sudo apt update && sudo apt install -y bash coreutils sed grep tee make gcc g++ binutils bzip2 gzip patch unzip tar cpio wget curl git subversion bc findutils
          echo "依赖安装完成"

      - name: 3. 关键前置：脚本赋权+切换到源码根目录
        run: |
          # 给三件套生成脚本添加可执行权限（云端默认无）
          chmod +x ${{ env.SCRIPT_NAME }}
          # 验证脚本权限
          ls -l ${{ env.SCRIPT_NAME }}
          # 切换到ImmortalWrt源码根目录（脚本必须在此执行）
          cd ${{ env.IWRT_ROOT }}
          pwd # 打印当前路径，便于调试

      - name: 4. 执行三件套生成脚本（核心步骤，生成DTS/MK/.config）
        run: |
          cd ${{ env.IWRT_ROOT }}
          # 执行脚本，终端+日志双输出，云端保留日志
          ./${{ env.SCRIPT_NAME }}
          echo "脚本执行完成，开始验证三件套是否生成"

      - name: 5. 强制校验：三件套文件存在性+非空（云端关键）
        run: |
          cd ${{ env.IWRT_ROOT }}
          # 定义三件套路径（和脚本内路径完全一致）
          DTS="target/linux/mediatek/filogic/dts/mt7981b-sl-3000-emmc.dts"
          MK="target/linux/mediatek/filogic/image/mt7981.mk"
          CFG=".config"
          # 校验存在性
          [ -f "$DTS" ] && echo "✅ DTS生成成功: $DTS" || { echo "❌ DTS未生成"; exit 1; }
          [ -f "$MK" ] && echo "✅ MK生成成功: $MK" || { echo "❌ MK未生成"; exit 1; }
          [ -f "$CFG" ] && echo "✅ CONFIG生成成功: $CFG" || { echo "❌ CONFIG未生成"; exit 1; }
          # 校验非空
          [ -s "$DTS" ] && echo "✅ DTS非空" || { echo "❌ DTS为空"; exit 1; }
          [ -s "$MK" ] && echo "✅ MK非空" || { echo "❌ MK为空"; exit 1; }
          [ -s "$CFG" ] && echo "✅ CONFIG非空" || { echo "❌ CONFIG为空"; exit 1; }
          echo "=== 三件套100%生成并验证通过 ==="

      - name: 6. 后续构建步骤（衔接你的原有构建逻辑）
        run: |
          cd ${{ env.IWRT_ROOT }}
          # 清理旧缓存
          make clean
          # 开始构建（根据云端CPU调整-j参数，Actions默认2核，用-j2）
          make -j2 V=s
          # 打印固件产物路径
          ls -la bin/targets/mediatek/filogic/ || echo "构建完成，查看产物"

      - name: 7. 上传固件产物（可选，保留构建结果）
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-firmware
          path: ${{ env.IWRT_ROOT }}/bin/targets/mediatek/filogic/
