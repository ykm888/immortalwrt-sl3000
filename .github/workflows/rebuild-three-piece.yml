name: Rebuild SL3000 Three-Piece (24.10 / mt7981)

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  rebuild-sl3000-three-piece:
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    defaults:
      run:
        shell: bash

    steps:
      - name: ğŸ“¥ Checkout Repository (Full History)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: âš™ï¸ Ensure Generation Script Executable
        run: chmod +x sl3000-tools/generate-three-piece.sh

      - name: ğŸ—„ï¸ Cache OpenWrt 24.10 Source (Reduce Redownload)
        uses: actions/cache@v3
        id: cache-openwrt-src
        with:
          path: openwrt-src
          key: openwrt-2410-src-filogic-mt7981
          restore-keys: |
            openwrt-2410-src-

      - name: ğŸ“¦ Clone OpenWrt 24.10 (3x Retry + Path Check)
        if: steps.cache-openwrt-src.outputs.cache-hit != 'true'
        run: |
          RETRIES=3
          COUNT=0
          until [ $COUNT -ge $RETRIES ]; do
            rm -rf openwrt-src && git clone --depth=1 -b openwrt-24.10 https://github.com/openwrt/openwrt.git openwrt-src && break
            COUNT=$((COUNT+1))
            echo "Clone failed, retry $COUNT/$RETRIES... (sleep 5s)"
            sleep 5
          done
          if [ $COUNT -ge $RETRIES ]; then
            echo "âŒ Fatal: Clone OpenWrt 24.10 failed after $RETRIES retries"
            exit 1
          fi
          # é¢„æ ¡éªŒMK/DTSçˆ¶è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼ˆåŒ¹é…æŒ‡å®šè·¯å¾„ï¼‰
          if [ ! -d "openwrt-src/target/linux/mediatek/dts" ] || [ ! -f "openwrt-src/target/linux/mediatek/image/filogic.mk" ]; then
            echo "âŒ Fatal: æŒ‡å®šçš„MK/DTSè·¯å¾„ä¸å­˜åœ¨ï¼Œæºç ç»“æ„å¼‚å¸¸"
            exit 1
          fi
          echo "âœ… OpenWrt 24.10 cloned and path verified successfully"

      - name: ğŸ”§ Fix Source Directory Permissions (Writable)
        run: chmod -R 755 openwrt-src

      - name: ğŸ§¹ Clean Pre-existing Config (Avoid Overwrite)
        working-directory: openwrt-src
        run: rm -f .config

      - name: ğŸš€ Run Three-Piece Script (Specified Path)
        working-directory: openwrt-src
        run: |
          bash $GITHUB_WORKSPACE/sl3000-tools/generate-three-piece.sh
          SCRIPT_EXIT_CODE=$?
          if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
            echo "âŒ Fatal: Script exited with code $SCRIPT_EXIT_CODE"
            exit 1
          fi
          echo "âœ… Script executed, three-piece generated to specified paths"

      - name: âœ… Strict Validation (Specified Path + Content + Standard)
        working-directory: openwrt-src
        run: |
          # ä¸¥æ ¼åŒ¹é…ä½ æŒ‡å®šçš„ä¸‰ä»¶å¥—è·¯å¾„
          DTS_FILE="target/linux/mediatek/dts/mt7981b-sl-3000-emmc.dts"
          MK_FILE="target/linux/mediatek/image/filogic.mk"
          CFG_FILE=".config"
          
          # è·¯å¾„+éç©ºæ ¡éªŒ
          [ -s "$DTS_FILE" ] || { echo "âŒ Fatal: DTSè·¯å¾„é”™è¯¯æˆ–æ–‡ä»¶ä¸ºç©º"; exit 1; }
          [ -s "$MK_FILE" ]  || { echo "âŒ Fatal: MKè·¯å¾„é”™è¯¯æˆ–æ–‡ä»¶ä¸ºç©º"; exit 1; }
          [ -s "$CFG_FILE" ] || { echo "âŒ Fatal: CONFIGè·¯å¾„é”™è¯¯æˆ–æ–‡ä»¶ä¸ºç©º"; exit 1; }
          
          # æ ¸å¿ƒå†…å®¹æ ¡éªŒ
          grep -q "sl,3000-emmc" "$DTS_FILE" || { echo "âŒ Fatal: DTSç¼ºå°‘è®¾å¤‡æ ‡è¯†"; exit 1; }
          grep -q "define Device/sl_3000-emmc" "$MK_FILE" || { echo "âŒ Fatal: MKç¼ºå°‘è®¾å¤‡æ®µ"; exit 1; }
          grep -q "TARGET_DEVICES += sl_3000-emmc" "$MK_FILE" || { echo "âŒ Fatal: MKç¼ºå°‘å®˜æ–¹å˜é‡"; exit 1; }
          grep -q "CONFIG_TARGET_DEVICE_mediatek_mt7981_DEVICE_sl_3000-emmc=y" "$CFG_FILE" || { echo "âŒ Fatal: CONFIGè®¾å¤‡æœªå¯ç”¨"; exit 1; }
          
          # å”¯ä¸€æ€§æ ¡éªŒ
          MK_SEG_COUNT=$(grep -c "define Device/sl_3000-emmc" "$MK_FILE")
          if [ $MK_SEG_COUNT -ne 1 ]; then
            echo "âŒ Fatal: MKå­˜åœ¨$MK_SEG_COUNTä¸ªé‡å¤è®¾å¤‡æ®µ"; exit 1;
          fi
          
          # ä¼ é€’è·¯å¾„åˆ°ç¯å¢ƒå˜é‡
          echo "DTS_FILE=$DTS_FILE" >> $GITHUB_ENV
          echo "MK_FILE=$MK_FILE" >> $GITHUB_ENV
          echo "CFG_FILE=$CFG_FILE" >> $GITHUB_ENV
          echo "âœ… All three-piece validated: specified path + valid content + official standard"

      - name: ğŸ“¤ Upload Artifact (Three-Piece + Log)
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-three-piece-2410-mt7981
          path: |
            openwrt-src/${{ env.DTS_FILE }}
            openwrt-src/${{ env.MK_FILE }}
            openwrt-src/${{ env.CFG_FILE }}
            $GITHUB_WORKSPACE/sl3000-tools/sl3000-three-piece.log
          retention-days: 30
          if-no-files-found: error

      - name: ğŸ“ Sync to Repository (Specified Path Copy)
        if: success()
        run: |
          # ä»“åº“å†…æŒä¹…åŒ–ç›®å½•ï¼ŒæŒ‰ç‰ˆæœ¬å­˜æ”¾
          mkdir -p sl3000-three-piece/24.10
          # ä»æŒ‡å®šè·¯å¾„å¤åˆ¶äº§ç‰©
          cp openwrt-src/${{ env.DTS_FILE }} sl3000-three-piece/24.10/
          cp openwrt-src/${{ env.MK_FILE }} sl3000-three-piece/24.10/
          cp openwrt-src/${{ env.CFG_FILE }} sl3000-three-piece/24.10/
          
          # Gitè‡ªåŠ¨æäº¤ï¼ˆä»…å˜æ›´æ—¶ï¼‰
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add sl3000-three-piece/
          git commit -m "chore: update SL3000 three-piece (24.10/mt7981) [auto-workflow]" || {
            echo "âœ… No changes to three-piece, skip commit"
            exit 0
          }
          git push origin $GITHUB_REF_NAME
          echo "âœ… Three-piece synced to repository successfully!"
