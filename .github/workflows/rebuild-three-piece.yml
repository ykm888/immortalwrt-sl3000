name: Rebuild SL3000 Three-Piece (24.10 / mt7981)
on:
  workflow_dispatch:
permissions:
  contents: write
  actions: read
jobs:
  rebuild-sl3000-three-piece:
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    defaults:
      run:
        shell: bash
    steps:
      - name: üì• Checkout Repository (Full History)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: ‚öôÔ∏è Check Script Path & Ensure Executable
        run: |
          ls -la $GITHUB_WORKSPACE/sl3000-tools/
          chmod +x $GITHUB_WORKSPACE/sl3000-tools/generate-three-piece.sh

      - name: üì¶ Force Clone OpenWrt 24.10 (3x Retry + Path Check)
        run: |
          RETRIES=3
          COUNT=0
          # Âº∫Âà∂Âà†Èô§ÊóßÁõÆÂΩïÔºåÈÅøÂÖçÊÆãÁïô/ÊçüÂùè
          rm -rf openwrt-src
          until [ $COUNT -ge $RETRIES ]; do
            git clone --depth=1 -b openwrt-24.10 https://github.com/openwrt/openwrt.git openwrt-src && break
            COUNT=$((COUNT+1))
            echo "Clone failed, retry $COUNT/$RETRIES... (sleep 5s)"
            sleep 5
          done
          if [ $COUNT -ge $RETRIES ]; then
            echo "‚ùå Fatal: Clone OpenWrt 24.10 failed after $RETRIES retries"
            exit 1
          fi
          # Ê†°È™åÊ†∏ÂøÉË∑ØÂæÑÔºåÁ°Æ‰øùÊ∫êÁ†ÅÂèØÁî®
          if [ ! -d "openwrt-src/target/linux/mediatek/dts" ] || [ ! -f "openwrt-src/target/linux/mediatek/image/filogic.mk" ]; then
            echo "‚ùå Fatal: MK/DTS parent path not exist, source broken"
            exit 1
          fi
          echo "‚úÖ OpenWrt 24.10 cloned successfully (force mode)"

      - name: üîß Full Write Permissions (Avoid Write Failed)
        run: chmod -R u+w openwrt-src

      - name: üßπ Clean Pre-existing Config (No Overwrite)
        working-directory: openwrt-src
        run: rm -f .config

      - name: üöÄ Run Script + Env Force Specify (Debug)
        working-directory: openwrt-src
        run: |
          # Âº∫Âà∂ÊåáÂÆöÊ∫êÁ†ÅÊ†πÁõÆÂΩïÔºåÊùúÁªùË∑ØÂæÑÈîôËØØ
          export OPENWRT_SRC="$(pwd)"
          bash $GITHUB_WORKSPACE/sl3000-tools/generate-three-piece.sh
          SCRIPT_EXIT_CODE=$?
          if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
            echo "‚ùå Fatal: Script exited with code $SCRIPT_EXIT_CODE"
            exit 1
          fi
          # Âº∫Âà∂ÂàóÂá∫ÁîüÊàêÁªìÊûúÔºåÁõ¥ËßÇÈ™åËØÅ
          echo -e "\n===== GENERATE RESULT LIST ====="
          ls -la .config
          ls -la target/linux/mediatek/dts/mt7981b-sl-3000-emmc.dts
          ls -la target/linux/mediatek/image/filogic.mk
          echo "‚úÖ Script run done, check above list for files"

      - name: ‚úÖ Strict Validation (Specified Path)
        working-directory: openwrt-src
        run: |
          DTS_FILE="target/linux/mediatek/dts/mt7981b-sl-3000-emmc.dts"
          MK_FILE="target/linux/mediatek/image/filogic.mk"
          CFG_FILE=".config"
          [ -s "$DTS_FILE" ] || { echo "‚ùå DTS empty/missing"; exit 1; }
          [ -s "$MK_FILE" ]  || { echo "‚ùå MK empty/missing"; exit 1; }
          [ -s "$CFG_FILE" ] || { echo "‚ùå CONFIG empty/missing"; exit 1; }
          grep -q "TARGET_DEVICES += sl_3000-emmc" "$MK_FILE" || { echo "‚ùå MK no device"; exit 1; }
          echo "DTS_FILE=$DTS_FILE" >> $GITHUB_ENV
          echo "MK_FILE=$MK_FILE" >> $GITHUB_ENV
          echo "CFG_FILE=$CFG_FILE" >> $GITHUB_ENV
          echo "‚úÖ All three-piece validated"

      - name: üì§ Upload Artifact (Files + Log)
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-three-piece-2410-mt7981
          path: |
            openwrt-src/${{ env.DTS_FILE }}
            openwrt-src/${{ env.MK_FILE }}
            openwrt-src/${{ env.CFG_FILE }}
            $GITHUB_WORKSPACE/sl3000-tools/sl3000-three-piece.log
          retention-days: 30
          if-no-files-found: error

      - name: üìù Sync to Repository
        if: success()
        run: |
          mkdir -p sl3000-three-piece/24.10
          cp openwrt-src/${{ env.DTS_FILE }} sl3000-three-piece/24.10/
          cp openwrt-src/${{ env.MK_FILE }} sl3000-three-piece/24.10/
          cp openwrt-src/${{ env.CFG_FILE }} sl3000-three-piece/24.10/
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add sl3000-three-piece/
          git commit -m "chore: update SL3000 three-piece (24.10/mt7981) [auto]" || { echo "‚úÖ No change, skip commit"; exit 0; }
          git push origin $GITHUB_REF_NAME
          echo "‚úÖ Synced to repo"
