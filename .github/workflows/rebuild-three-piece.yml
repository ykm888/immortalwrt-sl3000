name: Rebuild SL3000 Three-Piece (Final Fixed)

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  rebuild-sl3000-three-piece:
    runs-on: ubuntu-22.04
    timeout-minutes: 10

    steps:
      # 1. Checkout
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      # 2. Install dependencies
      - name: Install Core Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y device-tree-compiler dos2unix libc-bin

      # 3. Check script exists
      - name: Check Script Exists
        run: |
          if [ ! -f "sl3000-tools/generate-three-piece.sh" ]; then
            echo "❌ Script not found"
            exit 1
          fi
          echo "✅ Script found"

      # 4. Auto-detect files-6.x (NO touch, NO create empty files)
      - name: Detect files-6.x
        run: |
          FILES_DIR=$(ls -d target/linux/mediatek/files-* | head -n 1)
          echo "FILES_DIR=$FILES_DIR" >> $GITHUB_ENV
          echo "Detected FILES_DIR = $FILES_DIR"

      # 5. Add execute permission
      - name: Add Execute Permission
        run: chmod 755 sl3000-tools/*.sh

      # 6. Run script
      - name: Run Three-Piece Script
        run: |
          bash -x sl3000-tools/generate-three-piece.sh 2>&1 | tee sl3000-run.log

      # 7. Strict verify (use detected files-6.x)
      - name: Strict Verify Three-Piece
        run: |
          FILES_DIR="${FILES_DIR:-$(ls -d target/linux/mediatek/files-* | head -n 1)}"

          DTS_FILE="$FILES_DIR/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts"
          MK_FILE="target/linux/mediatek/image/filogic.mk"
          CFG_FILE=".config"

          echo "Verify DTS: $DTS_FILE"
          echo "Verify MK : $MK_FILE"
          echo "Verify CFG: $CFG_FILE"

          if [ ! -s "$DTS_FILE" ]; then
            echo "❌ DTS missing or empty"
            exit 1
          fi

          if [ ! -s "$CFG_FILE" ]; then
            echo "❌ CONFIG missing or empty"
            exit 1
          fi

          if ! grep -q "mt7981b-sl3000-emmc" "$MK_FILE"; then
            echo "❌ MK missing SL3000 segment"
            exit 1
          fi

          echo "=== SL3000 MK Segment ==="
          grep -A20 "define Device/mt7981b-sl3000-emmc" "$MK_FILE"

          echo "DTS_FILE=$DTS_FILE" >> $GITHUB_ENV
          echo "MK_FILE=$MK_FILE" >> $GITHUB_ENV
          echo "CFG_FILE=$CFG_FILE" >> $GITHUB_ENV

      # 8. Upload artifacts
      - name: Upload Three-Piece & Logs
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-three-piece-final
          path: |
            ${{ env.DTS_FILE }}
            ${{ env.MK_FILE }}
            ${{ env.CFG_FILE }}
            sl3000-run.log
          retention-days: 30

      # 9. Commit & push
      - name: Git Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -f ${{ env.DTS_FILE }} ${{ env.MK_FILE }} ${{ env.CFG_FILE }}

          git commit -m "ci: rebuild SL3000 three-piece (final fixed)" || {
            echo "No changes to commit"
            exit 0
          }

          git push
