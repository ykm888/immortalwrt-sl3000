name: SL3000 MT7981B eMMC - ImmortalWrt24.10 æ——èˆ°ç‰ˆæ„å»º
on:
  push:
    branches: [ main, master ]
    paths:
      - 'gen-sl3000-three-piece.sh'
      - '.github/workflows/**'
  workflow_dispatch: # ä¼˜å…ˆæ‰‹åŠ¨è§¦å‘
jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    env:
      # å½»åº•æŠ›å¼ƒç¡¬ç¼–ç ï¼ä½¿ç”¨GitHubå®˜æ–¹å†…ç½®ç¯å¢ƒå˜é‡ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
      # GITHUB_WORKSPACE = ä»“åº“å…‹éš†åçš„æ ¹ç›®å½•ï¼Œ100%é€‚é…æ‰€æœ‰Actionsç¯å¢ƒ
      SCRIPT_NAME: gen-sl3000-three-piece.sh
      DTS_PATH: target/linux/mediatek/filogic/dts/mt7981b-sl-3000-emmc.dts
      MK_PATH: target/linux/mediatek/filogic/image/mt7981.mk
      CFG_PATH: .config

    steps:
      - name: 1. å®Œæ•´æ‹‰å–ä»“åº“æºç ï¼ˆé»˜è®¤è·¯å¾„ï¼Œä¸è‡ªå®šä¹‰pathï¼Œé¿å…æ··ä¹±ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å®Œæ•´å…‹éš†ï¼Œç¦æ­¢æµ…å…‹éš†
          submodules: false # æ— ç‰¹æ®Šå­æ¨¡å—åˆ™è®¾ä¸ºfalseï¼Œå‡å°‘æŠ¥é”™

      - name: 2. å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆä¿®å¤tee+äº‘ç«¯å…¨é€‚é…ï¼‰
        run: |
          sudo apt update -y && sudo apt install -yq \
          coreutils sed grep make gcc g++ binutils bzip2 gzip patch unzip tar cpio \
          wget curl git subversion bc findutils file diffutils python3 \
          libssl-dev libncurses5-dev libreadline-dev libffi-dev zlib1g-dev
          # éªŒè¯æ ¸å¿ƒå·¥å…·
          which bash sed grep tee cat mkdir chmod make && echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          source /etc/profile && export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

      - name: 3. é…ç½®æ„å»ºç¼“å­˜ï¼ˆåŠ é€ŸäºŒæ¬¡æ„å»ºï¼‰
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/dl
            ${{ github.workspace }}/feeds
            ${{ github.workspace }}/staging_dir
            ${{ github.workspace }}/build_dir
          key: ${{ runner.os }}-sl3000-2410-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-sl3000-2410-

      - name: 4. æ ¸å¿ƒä¿®å¤ï¼šæ ¡éªŒè„šæœ¬å­˜åœ¨+èµ‹æƒï¼ˆä¸‰é‡æ ¡éªŒï¼Œæœç»æ‰¾ä¸åˆ°æ–‡ä»¶ï¼‰
        id: check_and_chmod
        run: |
          # æ‰“å°å½“å‰å·¥ä½œç›®å½•ï¼ˆè°ƒè¯•ç”¨ï¼Œå¯çœ‹åˆ°å®é™…è·¯å¾„ï¼‰
          echo "ğŸ” GitHubå®˜æ–¹å·¥ä½œç›®å½•: ${{ github.workspace }}"
          cd ${{ github.workspace }}
          echo "ğŸ” åˆ‡æ¢åå½“å‰è·¯å¾„: $(pwd)"
          
          # æ ¡éªŒ1ï¼šæ‰“å°ä»“åº“æ ¹ç›®å½•æ‰€æœ‰æ–‡ä»¶ï¼Œç›´è§‚çœ‹åˆ°è„šæœ¬æ˜¯å¦å­˜åœ¨
          echo "ğŸ” ä»“åº“æ ¹ç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -la ${{ github.workspace }}/
          
          # æ ¡éªŒ2ï¼šè„šæœ¬æ–‡ä»¶å­˜åœ¨æ€§ï¼ˆä¸å­˜åœ¨ç›´æ¥ç»ˆæ­¢å¹¶æç¤ºï¼‰
          if [ ! -f "${{ github.workspace }}/${{ env.SCRIPT_NAME }}" ]; then
            echo "âŒ è‡´å‘½é”™è¯¯ï¼š${{ env.SCRIPT_NAME }} æœªåœ¨ä»“åº“æ ¹ç›®å½•æ‰¾åˆ°ï¼"
            echo "ğŸ‘‰ è¯·ç¡®è®¤è„šæœ¬å·²æ”¾åœ¨ä»“åº“æ ¹ç›®å½•å¹¶æäº¤æ¨é€åˆ°GitHubï¼"
            exit 1
          fi
          
          # æ ¡éªŒ3ï¼šèµ‹æƒå¹¶éªŒè¯æƒé™
          chmod +x ${{ github.workspace }}/${{ env.SCRIPT_NAME }}
          if [ -x "${{ github.workspace }}/${{ env.SCRIPT_NAME }}" ]; then
            echo "âœ… è„šæœ¬èµ‹æƒæˆåŠŸï¼Œå¯æ‰§è¡Œï¼"
          else
            echo "âŒ è„šæœ¬èµ‹æƒå¤±è´¥ï¼"
            exit 1
          fi

      - name: 5. æ‰§è¡Œä¸‰ä»¶å¥—ç”Ÿæˆè„šæœ¬ï¼ˆå…¨ç¨‹åŸºäºå®˜æ–¹å·¥ä½œç›®å½•ï¼Œæ— è·¯å¾„æ­§ä¹‰ï¼‰
        id: gen_three_piece
        run: |
          cd ${{ github.workspace }}
          echo "ğŸ” æ‰§è¡Œè„šæœ¬çš„å½“å‰è·¯å¾„: $(pwd)"
          # æ‰§è¡Œè„šæœ¬å¹¶ä¿ç•™å®Œæ•´æ—¥å¿—
          ./${{ env.SCRIPT_NAME }} 2>&1
          echo "âœ… ä¸‰ä»¶å¥—è„šæœ¬æ‰§è¡Œå®Œæˆ"

      - name: 6. å¼ºåˆ¶æ ¡éªŒä¸‰ä»¶å¥—ï¼ˆå­˜åœ¨æ€§+éç©ºï¼Œæœªç”Ÿæˆç›´æ¥ç»ˆæ­¢ï¼‰
        id: check_three_piece
        run: |
          cd ${{ github.workspace }}
          # æ ¡éªŒDTS
          if [ -s "${{ env.DTS_PATH }}" ]; then echo "âœ… DTSæ–‡ä»¶ï¼šå­˜åœ¨ä¸”éç©º"; else echo "âŒ DTSæ–‡ä»¶ï¼šç¼ºå¤±æˆ–ä¸ºç©º"; exit 1; fi
          # æ ¡éªŒMK
          if [ -s "${{ env.MK_PATH }}" ]; then echo "âœ… MKæ–‡ä»¶ï¼šå­˜åœ¨ä¸”éç©º"; else echo "âŒ MKæ–‡ä»¶ï¼šç¼ºå¤±æˆ–ä¸ºç©º"; exit 1; fi
          # æ ¡éªŒCONFIG
          if [ -s "${{ env.CFG_PATH }}" ]; then echo "âœ… CONFIGæ–‡ä»¶ï¼šå­˜åœ¨ä¸”éç©º"; else echo "âŒ CONFIGæ–‡ä»¶ï¼šç¼ºå¤±æˆ–ä¸ºç©º"; exit 1; fi
          # æ‰“å°æ–‡ä»¶å¤§å°
          du -sh ${{ env.DTS_PATH }} ${{ env.MK_PATH }} ${{ env.CFG_PATH }}
          echo "=== ä¸‰ä»¶å¥—100%éªŒè¯é€šè¿‡ ==="

      - name: 7. æ›´æ–°Feedsï¼ˆé€‚é…æ——èˆ°åŠŸèƒ½åŒ…ä¾èµ–ï¼‰
        run: |
          cd ${{ github.workspace }}
          ./scripts/feeds update -a && ./scripts/feeds install -a
          echo "âœ… Feedsæ›´æ–°å®‰è£…å®Œæˆ"

      - name: 8. æ„å»ºå›ºä»¶ï¼ˆäº‘ç«¯2æ ¸é€‚é…ï¼Œ-j2é¿å…è¿‡è½½ï¼‰
        id: build_firmware
        run: |
          cd ${{ github.workspace }}
          make clean
          make -j2 V=s
          echo "âœ… å›ºä»¶æ„å»ºå®Œæˆ"

      - name: 9. æ ¡éªŒå›ºä»¶äº§ç‰©
        run: |
          cd ${{ github.workspace }}
          FIRMWARE_DIR=bin/targets/mediatek/filogic
          if [ -d $FIRMWARE_DIR ]; then ls -la $FIRMWARE_DIR/; else echo "âŒ å›ºä»¶ç›®å½•ç¼ºå¤±"; exit 1; fi
          if [ -s $FIRMWARE_DIR/*sysupgrade.bin ]; then echo "âœ… sysupgradeå›ºä»¶ç”ŸæˆæˆåŠŸ"; else echo "âŒ sysupgradeå›ºä»¶ç¼ºå¤±"; exit 1; fi
          if [ -s $FIRMWARE_DIR/*factory.bin ]; then echo "âœ… factoryå›ºä»¶ç”ŸæˆæˆåŠŸ"; else echo "âŒ factoryå›ºä»¶ç¼ºå¤±"; exit 1; fi

      - name: 10. ä¸Šä¼ å›ºä»¶å’Œæ—¥å¿—
        uses: actions/upload-artifact@v4
        with:
          name: SL3000-ImmortalWrt2410-æ——èˆ°ç‰ˆå›ºä»¶
          path: |
            ${{ github.workspace }}/bin/targets/mediatek/filogic/
            ${{ github.workspace }}/*.log
          retention-days: 90
