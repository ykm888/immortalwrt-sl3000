name: generate-sl3000-three-piece

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-three-piece:
    runs-on: ubuntu-22.04
    timeout-minutes: 20

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Prepare workspace
        run: |
          sudo rm -rf /mnt/openwrt
          sudo mkdir -p /mnt/openwrt
          sudo chown -R $USER:$USER /mnt/openwrt

      - name: Clone OpenWrt 24.10
        run: |
          git clone --depth=1 -b openwrt-24.10 \
            https://github.com/openwrt/openwrt.git /mnt/openwrt

      - name: Ensure script executable
        run: chmod +x repo/sl3000-tools/generate-three-piece.sh

      - name: Run three-piece generator
        working-directory: /mnt/openwrt
        run: |
          echo "PWD: $(pwd)"
          rm -f .config

          bash $GITHUB_WORKSPACE/repo/sl3000-tools/generate-three-piece.sh

          echo "=== After script, check .config ==="
          if [ ! -s ".config" ]; then
            echo "‚ùå .config not generated"
            exit 1
          fi

      - name: Validate three-piece
        working-directory: /mnt/openwrt
        run: |
          DTS=target/linux/mediatek/dts/mt7981b-sl-3000-emmc.dts

          if [ -f target/linux/mediatek/image/mt7981.mk ]; then
            MK=target/linux/mediatek/image/mt7981.mk
          else
            MK=target/linux/mediatek/image/filogic.mk
          fi

          CFG=.config

          echo "=== Check DTS ==="
          [ -s "$DTS" ] || { echo "[FATAL] DTS missing"; exit 1; }

          echo "=== Check MK ==="
          grep -q "define Device/sl_3000-emmc" "$MK" \
            || { echo "[FATAL] MK missing Device/sl_3000-emmc"; exit 1; }
          grep -q "TARGET_DEVICES += sl3000-emmc" "$MK" \
            || { echo "[FATAL] MK missing TARGET_DEVICES"; exit 1; }

          echo "=== Check CONFIG ==="
          grep -q '^CONFIG_TARGET_DEVICE_mediatek_mt7981_DEVICE_sl_3000-emmc=y' "$CFG" \
            || { echo "[FATAL] CONFIG missing device enable"; exit 1; }

      - name: Upload three-piece artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-three-piece
          path: |
            /mnt/openwrt/target/linux/mediatek/dts/mt7981b-sl-3000-emmc.dts
            /mnt/openwrt/target/linux/mediatek/image/filogic.mk
            /mnt/openwrt/.config
