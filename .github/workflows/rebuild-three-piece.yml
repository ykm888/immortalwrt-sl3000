name: Rebuild SL3000 Three-Piece (24.10 / mt7981)

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  rebuild-sl3000-three-piece:
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    defaults:
      run:
        shell: bash

    steps:
      - name: ğŸ“¥ Checkout Repository (Full History)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: âš™ï¸ Ensure Generation Script Executable
        run: chmod +x sl3000-tools/generate-three-piece.sh

      - name: ğŸ—„ï¸ Cache OpenWrt 24.10 Source (Reduce Redownload)
        uses: actions/cache@v3
        id: cache-openwrt-src
        with:
          path: openwrt-src
          key: openwrt-2410-src-filogic-mt7981
          restore-keys: |
            openwrt-2410-src-

      - name: ğŸ“¦ Clone OpenWrt 24.10 (3x Retry + Integrity Check)
        if: steps.cache-openwrt-src.outputs.cache-hit != 'true'
        run: |
          RETRIES=3
          COUNT=0
          # 3æ¬¡é‡è¯•æ‹‰å–æºç ï¼Œç½‘ç»œæ³¢åŠ¨è‡ªåŠ¨é‡è¿
          until [ $COUNT -ge $RETRIES ]; do
            rm -rf openwrt-src && git clone --depth=1 -b openwrt-24.10 https://github.com/openwrt/openwrt.git openwrt-src && break
            COUNT=$((COUNT+1))
            echo "Clone failed, retry $COUNT/$RETRIES... (sleep 5s)"
            sleep 5
          done
          # æ‹‰å–å¤±è´¥ç›´æ¥ç»ˆæ­¢
          if [ $COUNT -ge $RETRIES ]; then
            echo "âŒ Fatal: Clone OpenWrt 24.10 failed after $RETRIES retries"
            exit 1
          fi
          # æ ¡éªŒæ ¸å¿ƒæ–‡ä»¶ï¼Œé˜²æ­¢æºç ç›®å½•ç»“æ„å˜æ›´å¯¼è‡´åç»­å¤±è´¥
          if [ ! -f "openwrt-src/target/linux/mediatek/image/filogic.mk" ]; then
            echo "âŒ Fatal: OpenWrt 24.10 missing filogic.mk (directory structure changed)"
            exit 1
          fi
          echo "âœ… OpenWrt 24.10 cloned and verified successfully"

      - name: ğŸ”§ Fix OpenWrt Source Directory Permissions (Writable)
        run: chmod -R 755 openwrt-src

      - name: ğŸ§¹ Clean Pre-existing Empty Config (Avoid Overwrite)
        working-directory: openwrt-src
        run: rm -f .config

      - name: ğŸš€ Run Three-Piece Generation Script (Strict Env)
        working-directory: openwrt-src
        run: |
          # ç»å¯¹è·¯å¾„æ‰§è¡Œè„šæœ¬ï¼Œå¼ºåˆ¶æºç æ ¹ç›®å½•ç¯å¢ƒ
          bash $GITHUB_WORKSPACE/sl3000-tools/generate-three-piece.sh
          SCRIPT_EXIT_CODE=$?
          # æ ¡éªŒè„šæœ¬æ‰§è¡Œè¿”å›ç ï¼Œé0ç›´æ¥ç»ˆæ­¢
          if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
            echo "âŒ Fatal: Generation script exited with code $SCRIPT_EXIT_CODE"
            exit 1
          fi
          # å³æ—¶éªŒè¯.configç”Ÿæˆç»“æœ
          if [ ! -s ".config" ]; then
            echo "âŒ Fatal: .config not generated or empty after script run"
            exit 1
          fi
          echo "âœ… Generation script executed successfully, .config generated"

      - name: âœ… Strict Three-Piece Validation (Exist+Content+Unique)
        working-directory: openwrt-src
        run: |
          # å®šä¹‰æ ¸å¿ƒæ–‡ä»¶è·¯å¾„
          DTS_FILE="target/linux/mediatek/dts/mt7981b-sl-3000-emmc.dts"
          MK_FILE="target/linux/mediatek/image/filogic.mk"
          CFG_FILE=".config"
          # æ ¡éªŒæ–‡ä»¶å­˜åœ¨ä¸”éç©º
          [ -s "$DTS_FILE" ] || { echo "âŒ Fatal: DTS missing or empty"; exit 1; }
          [ -s "$MK_FILE" ]  || { echo "âŒ Fatal: MK missing or empty"; exit 1; }
          [ -s "$CFG_FILE" ] || { echo "âŒ Fatal: CONFIG missing or empty"; exit 1; }
          # æ ¡éªŒæ ¸å¿ƒé…ç½®é¡¹ç”Ÿæ•ˆ
          grep -q "CONFIG_TARGET_DEVICE_mediatek_mt7981_DEVICE_sl_3000-emmc=y" "$CFG_FILE" \
            || { echo "âŒ Fatal: CONFIG missing device enable config"; exit 1; }
          grep -q "define Device/sl_3000-emmc" "$MK_FILE" \
            || { echo "âŒ Fatal: MK missing sl_3000-emmc device segment"; exit 1; }
          # æ ¡éªŒMKè®¾å¤‡æ®µå”¯ä¸€ï¼Œé˜²æ­¢é‡å¤æ·»åŠ 
          MK_SEG_COUNT=$(grep -c "define Device/sl_3000-emmc" "$MK_FILE")
          if [ $MK_SEG_COUNT -ne 1 ]; then
            echo "âŒ Fatal: MK has $MK_SEG_COUNT device segments (expected 1, duplicate found)"
            exit 1
          fi
          # ä¼ é€’æ–‡ä»¶è·¯å¾„åˆ°ç¯å¢ƒå˜é‡
          echo "DTS_FILE=$DTS_FILE" >> $GITHUB_ENV
          echo "MK_FILE=$MK_FILE" >> $GITHUB_ENV
          echo "CFG_FILE=$CFG_FILE" >> $GITHUB_ENV
          echo "âœ… All three-piece files validated successfully (exist+content+unique)"

      - name: ğŸ“¤ Upload Three-Piece + Execution Log (Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-three-piece-2410-mt7981
          path: |
            openwrt-src/${{ env.DTS_FILE }}
            openwrt-src/${{ env.MK_FILE }}
            openwrt-src/${{ env.CFG_FILE }}
            $GITHUB_WORKSPACE/sl3000-tools/sl3000-three-piece.log
          retention-days: 30
          if-no-files-found: error

      - name: ğŸ“ Sync Three-Piece to Repository (Auto Commit/Push)
        if: success()
        run: |
          # åˆ›å»ºä»“åº“å†…ä¸‰ä»¶å¥—æŒä¹…åŒ–ç›®å½•
          mkdir -p sl3000-three-piece/24.10
          # å¤åˆ¶æœ€æ–°ç”Ÿæˆçš„ä¸‰ä»¶å¥—åˆ°ä»“åº“ç›®å½•
          cp openwrt-src/${{ env.DTS_FILE }} sl3000-three-piece/24.10/
          cp openwrt-src/${{ env.MK_FILE }} sl3000-three-piece/24.10/
          cp openwrt-src/${{ env.CFG_FILE }} sl3000-three-piece/24.10/
          # é…ç½®Gitæäº¤ä¿¡æ¯
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # ä»…å½“æœ‰å˜æ›´æ—¶æäº¤ï¼Œé¿å…ç©ºæäº¤
          git add sl3000-three-piece/
          git commit -m "chore: update SL3000 three-piece (24.10/mt7981) [auto-workflow]" || {
            echo "âœ… No changes to three-piece, skip commit"
            exit 0
          }
          # æ¨é€å˜æ›´åˆ°ä»“åº“
          git push origin $GITHUB_REF_NAME
          echo "âœ… Three-piece synced to repository successfully"
