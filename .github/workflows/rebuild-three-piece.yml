name: Rebuild SL3000 Three-Piece

on:
  workflow_dispatch:

jobs:
  rebuild:
    runs-on: ubuntu-22.04

    steps:
      # 1. 检出仓库（锁定 main）
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      # 2. 设置脚本权限
      - name: Make scripts executable
        run: |
          chmod +x sl3000-tools/generate-three-piece.sh
          chmod +x sl3000-tools/all-in-one.sh

      # ⭐ 3. 更新 feeds（DTS include 必须存在）
      - name: Update feeds
        run: |
          ./scripts/feeds update -a || true
          ./scripts/feeds install -a

      # ⭐ 4. 生成默认配置（确保 .config 存在）
      - name: Normalize config
        run: |
          make defconfig

      # ⭐ 5. 构建工具链（生成 build_dir + kernel include）
      - name: Build toolchain
        run: |
          make toolchain/install -j$(nproc) V=s

      # ⭐ 6. 生成三件套（DTS / MK / CONFIG）
      - name: Generate three-piece
        run: |
          ./sl3000-tools/generate-three-piece.sh

      # ⭐ 7. 运行 DTS 检查（此时环境已准备好）
      - name: Run all-in-one CHECK
        run: |
          ./sl3000-tools/all-in-one.sh check

      # 8. 上传三件套产物
      - name: Upload three-piece artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-three-piece
          path: |
            target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts
            target/linux/mediatek/image/filogic.mk
            .config

      # 9. 推送三件套到仓库
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts
          git add target/linux/mediatek/image/filogic.mk
          git add .config

          git commit -m "ci: auto rebuild SL3000 three-piece (24.10 / 6.6)" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/ykm888/immortalwrt-sl3000.git main
