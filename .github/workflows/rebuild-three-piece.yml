name: SL3000 MT7981B eMMC - ImmortalWrt24.10 旗舰版构建
on:
  push:
    branches: [ main, master ]
    paths:
      - 'sl3000-tools/generate-three-piece.sh'
      - '.github/workflows/**'
  workflow_dispatch: # 优先手动触发（推荐）
jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    timeout-minutes: 360 # 6小时超时，适配大固件构建
    env:
      # 精准匹配你的实际脚本信息（核心修改点）
      SCRIPT_NAME: generate-three-piece.sh    # 实际脚本名
      SCRIPT_SUB_DIR: sl3000-tools            # 实际脚本所在子文件夹
      # 三件套路径（与脚本内生成路径保持一致，无需修改）
      DTS_PATH: target/linux/mediatek/filogic/dts/mt7981b-sl-3000-emmc.dts
      MK_PATH: target/linux/mediatek/filogic/image/mt7981.mk
      CFG_PATH: .config

    steps:
      - name: 1. 完整拉取仓库源码（禁止浅克隆，避免目录缺失）
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: 2. 安装基础依赖（修复tee错误+云端环境全适配）
        run: |
          sudo apt update -y && sudo apt install -yq \
          coreutils sed grep make gcc g++ binutils bzip2 gzip patch unzip tar cpio \
          wget curl git subversion bc findutils file diffutils python3 \
          libssl-dev libncurses5-dev libreadline-dev libffi-dev zlib1g-dev
          # 验证核心工具是否可用
          which bash sed grep tee cat mkdir chmod make && echo "✅ 基础依赖安装完成"
          # 刷新环境变量，避免云端路径异常
          source /etc/profile && export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

      - name: 3. 核心容错：检测并移动实际脚本到根目录（精准匹配你的路径）
        id: find_and_move_script
        run: |
          cd ${{ github.workspace }}
          echo "🔍 开始检测脚本：${{ env.SCRIPT_SUB_DIR }}/${{ env.SCRIPT_NAME }}"
          # 检测实际脚本路径是否存在
          if [ ! -f "${{ env.SCRIPT_SUB_DIR }}/${{ env.SCRIPT_NAME }}" ]; then
            echo "❌ 致命错误：未找到脚本！请确认路径为${{ env.SCRIPT_SUB_DIR }}/${{ env.SCRIPT_NAME }}"
            exit 1
          fi
          # 自动将脚本移动到仓库根目录（解决执行路径问题）
          mv ${{ env.SCRIPT_SUB_DIR }}/${{ env.SCRIPT_NAME }} ./
          echo "✅ 脚本已从${{ env.SCRIPT_SUB_DIR }}移动到仓库根目录"
          # 验证根目录是否存在脚本
          ls -la ${{ env.SCRIPT_NAME }} && echo "✅ 脚本移动后验证成功"

      - name: 4. 脚本赋权（云端默认无执行权限，必做）
        id: chmod_script
        run: |
          cd ${{ github.workspace }}
          chmod +x ${{ env.SCRIPT_NAME }}
          # 验证可执行权限
          [ -x "${{ env.SCRIPT_NAME }}" ] && echo "✅ 脚本赋权成功，具备可执行权限" || { echo "❌ 脚本赋权失败"; exit 1; }

      - name: 5. 配置构建缓存（加速二次构建，节省90%时间）
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/dl
            ${{ github.workspace }}/feeds
            ${{ github.workspace }}/staging_dir
            ${{ github.workspace }}/build_dir
          key: ${{ runner.os }}-sl3000-2410-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-sl3000-2410-

      - name: 6. 执行三件套生成脚本（核心步骤，生成DTS/MK/.config）
        id: gen_three_piece
        run: |
          cd ${{ github.workspace }}
          echo "🔍 开始执行三件套生成脚本：./${{ env.SCRIPT_NAME }}"
          # 执行脚本并保留完整日志，便于排查
          ./${{ env.SCRIPT_NAME }} 2>&1
          echo "✅ 三件套生成脚本执行完成"

      - name: 7. 强制校验三件套（存在性+非空，未生成直接终止）
        id: check_three_piece
        run: |
          cd ${{ github.workspace }}
          echo "🔍 开始校验三件套文件"
          # 逐个校验：存在且非空
          [ -s "${{ env.DTS_PATH }}" ] && echo "✅ DTS文件：存在且非空" || { echo "❌ DTS文件异常"; exit 1; }
          [ -s "${{ env.MK_PATH }}" ] && echo "✅ MK文件：存在且非空" || { echo "❌ MK文件异常"; exit 1; }
          [ -s "${{ env.CFG_PATH }}" ] && echo "✅ CONFIG文件：存在且非空" || { echo "❌ CONFIG文件异常"; exit 1; }
          # 打印文件大小，辅助调试
          du -sh ${{ env.DTS_PATH }} ${{ env.MK_PATH }} ${{ env.CFG_PATH }}
          echo "=== 三件套100%验证通过 ==="

      - name: 8. 更新&安装Feeds（适配Docker/Passwall2/SSR Plus+依赖）
        run: |
          cd ${{ github.workspace }}
          ./scripts/feeds update -a && ./scripts/feeds install -a
          echo "✅ Feeds源更新&安装完成，旗舰功能包依赖就绪"

      - name: 9. 构建固件（适配云端2核CPU，避免过载中断）
        id: build_firmware
        run: |
          cd ${{ github.workspace }}
          # 清理旧缓存，避免编译冲突
          make clean
          # 云端默认2核，固定-j2，V=s打印详细编译日志
          make -j2 V=s
          echo "✅ 固件编译完成，开始校验产物"

      - name: 10. 校验固件产物（确保生成可刷机固件）
        run: |
          cd ${{ github.workspace }}
          FIRMWARE_DIR=bin/targets/mediatek/filogic
          # 校验固件目录
          [ -d "$FIRMWARE_DIR" ] && echo "✅ 固件目录存在" || { echo "❌ 固件目录缺失"; exit 1; }
          # 校验核心刷机固件
          [ -s "$FIRMWARE_DIR/*sysupgrade.bin" ] && echo "✅ sysupgrade升级固件生成成功" || { echo "❌ sysupgrade固件缺失"; exit 1; }
          [ -s "$FIRMWARE_DIR/*factory.bin" ] && echo "✅ factory原厂固件生成成功" || { echo "❌ factory固件缺失"; exit 1; }
          # 列出所有固件文件
          ls -la $FIRMWARE_DIR/

      - name: 11. 上传固件+日志（永久保留，可直接下载）
        uses: actions/upload-artifact@v4
        with:
          name: SL3000-ImmortalWrt2410-旗舰版固件
          path: |
            ${{ github.workspace }}/bin/targets/mediatek/filogic/
            ${{ github.workspace }}/*.log # 保留三件套生成日志
          retention-days: 90 # 固件保留90天，可改为unlimited永久保留
