name: ImmortalWrt SL3000 Two-Stage Build

on:
  workflow_dispatch:

jobs:
  toolchain:
    runs-on: ubuntu-22.04
    name: Build Toolchain Only

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git-core libncurses5-dev \
            zlib1g-dev gawk flex gettext wget unzip python3 python3-distutils \
            file libssl-dev rsync ccache

      - name: Clone ImmortalWrt source
        run: |
          git clone --depth=1 -b openwrt-24.10 https://github.com/ykm888/immortalwrt-sl3000.git openwrt

      - name: Copy root .config
        run: |
          cp .config openwrt/.config

      - name: Build toolchain only
        run: |
          cd openwrt
          make defconfig
          make toolchain/install -j$(nproc) V=s

      - name: Cache toolchain
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir
            openwrt/build_dir/toolchain-*
          key: toolchain-${{ github.sha }}
          restore-keys: |
            toolchain-

  firmware:
    runs-on: ubuntu-22.04
    needs: toolchain
    name: Build Firmware

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git-core libncurses5-dev \
            zlib1g-dev gawk flex gettext wget unzip python3 python3-distutils \
            file libssl-dev rsync ccache

      - name: Restore toolchain cache
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir
            openwrt/build_dir/toolchain-*
          key: toolchain-${{ github.sha }}
          restore-keys: |
            toolchain-

      - name: Clone ImmortalWrt source
        run: |
          git clone --depth=1 -b openwrt-24.10 https://github.com/ykm888/immortalwrt-sl3000.git openwrt

      - name: Copy root .config
        run: |
          cp .config openwrt/.config

      - name: Build firmware
        run: |
          cd openwrt
          make defconfig
          make -j$(nproc) V=s | tee build.log

      - name: Upload build log
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: openwrt/build.log

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: openwrt/bin/targets/mediatek/filogic/
