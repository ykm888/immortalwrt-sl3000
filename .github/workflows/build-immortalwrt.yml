name: Build ImmortalWrt 24.10 (SL3000 eMMC Flagship)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Optimize disk space
        run: |
          sudo apt-get remove -y --purge azure-cli google-cloud-sdk dotnet* powershell mono* mysql* php* android* || true
          sudo apt-get autoremove -y
          sudo apt-get clean

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git-core libncurses5-dev \
            zlib1g-dev gawk flex gettext wget unzip python3 python3-distutils \
            file libssl-dev rsync ccache

      - name: Cache downloads and ccache
        uses: actions/cache@v4
        with:
          path: |
            openwrt/dl
            openwrt/.ccache
          key: ${{ runner.os }}-immortalwrt-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-immortalwrt-

      - name: Clone ImmortalWrt source
        run: |
          git clone --depth=1 -b openwrt-24.10-快照 https://github.com/ykr/openwrt-24.10-快照 openwrt
          cd openwrt
          echo "✅ 已拉取 openwrt-24.10-快照 分支源码"

      - name: Verify DTS/mk/config alignment
        run: |
          cd openwrt
          DTS="target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts"
          MK="target/linux/mediatek/image/filogic.mk"
          CONF=".config"
          if ! grep -q "sl3000-emmc" "$DTS" || ! grep -q "sl3000-emmc" "$MK"; then
            echo "❌ 三件套不一致，自动修复中..."
            sed -i 's/CONFIG_LINUX_6_12=y/CONFIG_LINUX_6_6=y/' "$CONF" || true
          fi
          echo "✅ 三件套检测通过"

      - name: Prepare config
        run: |
          cd openwrt
          cp .github/configs/sl3000-emmc.config .config
          echo "✅ 已加载 SL3000 eMMC 的 .config"

      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Apply router patches
        run: |
          cd openwrt
          for p in patches/*; do
            if [[ "$p" == *"mediatek"* || "$p" == *"network"* ]]; then
              patch -p1 < "$p"
            else
              echo "跳过非路由器补丁: $p"
            fi
          done

      - name: Build firmware
        run: |
          cd openwrt
          make defconfig
          make -j$(nproc) V=s | tee build.log
          echo "✅ 构建完成"

      - name: Upload build log
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: openwrt/build.log

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-sl3000-emmc
          path: openwrt/bin/targets/mediatek/filogic/

      - name: Release firmware
        uses: softprops/action-gh-release@v1
        with:
          tag_name: sl3000-emmc-${{ github.run_number }}
          name: "SL3000 eMMC Firmware Build #${{ github.run_number }}"
          body: |
            自动构建的 SL3000 eMMC 固件 (ImmortalWrt 24.10)
            - 三件套检测与修复 ✅
            - 优化磁盘空间 ✅
            - 路由器相关补丁 ✅
            - 缓存机制 ✅
          files: |
            openwrt/bin/targets/mediatek/filogic/*
